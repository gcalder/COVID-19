---
title: "Monitoring the COVID-19 Pandemic in Scotland"
date: "`r format(Sys.time()-lubridate::days(1), '%d %B, %Y')`" 
header-includes:
   - \usepackage{booktabs}
   - \usepackage{float}
   - \floatplacement{figure}{H}
   - \floatplacement{table}{H}
   - \usepackage{pdflscape}
   - \newcommand{\blandscape}{\begin{landscape}}
   - \newcommand{\elandscape}{\end{landscape}}
   - \usepackage[font=small,skip=5pt]{caption}
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: no
urlcolor: blue
link-citations: yes
linkcolor: black
---

<!--**Helen Brown^1^, Giles Calder-Gerver^2^, Samuel Haynes^3^, Stella Mazeri^1^, Camille A Simonet^4^, Mark Woolhouse^2,3,\*^**
\hfill \break

^1^The Roslin Institute and The Royal (Dick) School of Veterinary Studies, University of Edinburgh, Edinburgh, UK. ^2^Usher Institute, University of Edinburgh, Edinburgh, UK. ^3^School of Biological Sciences, University of Edinburgh, Edinburgh, UK. ^4^Institute of Evolutionary Biology, School of Biological Sciences, University of Edinburgh, Edinburgh, UK \newline

^\*^Email: Mark.Woolhouse@ed.ac.uk \newline -->


```{r setup, include=FALSE}
#date: "`r format(Sys.time(), '%d %B, %Y')`" 
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.pos = 'H')
# Load packages
library(flexdashboard) ; library(shiny) ; library(readr); library(dplyr); library(tidyr); library(purrr); library(forcats); library(stringr); library(htmlwidgets); library(lubridate); library(sf); library(RcppRoll); library(plotly); library(shinythemes);library(leaflet); library(classInt); library(ggrepel); library(scales); library(leaflet.extras); library(RColorBrewer);library(toOrdinal);library(knitr);library(kableExtra);library(RcppRoll);
library(colorblindr); library(readxl);library(spatstat.utils);library(httr);library(cowplot); library(viridis);library(naniar);
library(patchwork)

#source("growth_rate_window.R")
source("weekly_ratios_2.R")
weekly_ratios <- weekly_ratios_2
#source("weekly_ratios_byday.R")

# Import healthboard pop data 
hb_pop <- read_csv("/Users/gcalder2/OneDrive - University of Edinburgh/GitRepos/COVID-19/covid_19/Scotland_Population_Size_By_HealthBoard.csv") %>%
  select(Health_Board, Pop_Size) %>%
  slice(1:14) %>%
  mutate(health_board = str_replace(Health_Board, "and ", "& ")) %>%
  mutate(health_board = recode(health_board, "Ayrshire" = "Ayrshire & Arran"))

# # Import HB data
# url_hps_hb <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/coronavirus-covid-19-trends-in-daily-data/documents/covid-19-data-by-nhs-board/covid-19-data-by-nhs-board/govscot%3Adocument/COVID--19%2Bdata%2Bby%2BNHS%2BBoard%2B16%2BMay%2B2020.xlsx?forceDownload=true"
# GET(url_hps_hb, write_disk(tmp <- tempfile(fileext = ".xlsx")))
# GET(url_hps_hb, write_disk("hps_daily_hb.xlsx", overwrite = TRUE))
# hb_cases <- read_excel(tmp, sheet = "Table 1 - Cumulative cases")
# hb_icu <- read_excel(tmp, sheet = "Table 2 - ICU patients")
# hb_hosp_conf <- read_excel(tmp, sheet = "Table 3a - Hospital Confirmed")
# hb_hosp_susp <- read_excel(tmp, sheet = "Table 3b- Hospital Suspected")

# Import hospital data
## Covid daily hospital data
myurl <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/coronavirus-covid-19-trends-in-daily-data/documents/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/govscot%3Adocument/Trends%2Bin%2Bdaily%2BCOVID-19%2Bdata%2B-%2B110520.xlsx?forceDownload=true"
#myurl <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/documents/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/govscot%3Adocument/Data%2BTable%2B%252810-04-2020%2529.xlsx?forceDownload=true"
GET(myurl, write_disk(tmp_hps <- tempfile(fileext = ".xlsx")))
GET(myurl, write_disk("hps_daily.xlsx", overwrite = TRUE))

#data_hosp <- read_excel(tmp, sheet = "Table 1", skip = 3)
data_hosp <- read_excel(tmp_hps, sheet = "Table 2 - Hospital Care", skip = 3)
data_hosp <- read_excel(tmp_hps, sheet = "Table 2 - Hospital Care", skip =2)
data_hosp_old <- read_excel(tmp_hps, sheet = "Table 2 - Archive Hospital Care", skip = 3)
data_tests <- read_excel(tmp_hps, sheet = "Table 5 - Testing")
data_deaths <- read_excel(tmp_hps, sheet = "Table 8 - Deaths", skip =2)
#data_hosp <- filter(data_hosp, `...1` != Sys.Date()) # CHANGE


data_hosp <- data_hosp %>%
             mutate(date = ymd(`Reporting Date`)) %>%
             rename(ICU_total = `(i) COVID-19 patients in ICU\r\n or combined ICU/HDU (with length of stay 28 days or less)`,
                    Hospital_total = `(ii) COVID-19 patients in hospital (including those in ICU) (with length of stay 28 days or less)`) %>%
  #filter(date < Sys.Date()) %>% #remove today's data
mutate(date = date - days(1))

data_hosp_old <- data_hosp_old %>%
  rename(ICU_total = `Confirmed...2`, 
         Hospital_total = `Confirmed...5`) %>%
  mutate(date = ymd(`...1`)) %>%
  select(ICU_total, Hospital_total, date) %>%
#filter(date < Sys.Date()) %>% #remove today's data
mutate(date = date - days(1)) %>%
  filter(date < min(data_hosp$date))

data_hosp <- bind_rows(data_hosp_old, data_hosp)

# data_hosp <- data_hosp %>%
#   rename("date" = "...1",
#          "ICU_confirmed" = "Confirmed...2",
#          "ICU_suspected" ="Suspected...3", 
#          "ICU_total" = "Total...4",
#          "Hospital_confirmed" = "Confirmed...5",
#          "Hospital_suspected" = "Suspected...6",
#          "Hospital_total" = "Total...7" ) %>%
#   filter(!is.na(ICU_total)) %>%
#   mutate(date = lubridate::ymd(date)) %>%
#   mutate(ICU_confsusp = case_when(is.na(ICU_confirmed) & is.na(ICU_suspected) ~ ICU_total)) %>%
#   mutate(Hospital_confsusp = case_when(is.na(Hospital_confirmed) & is.na(Hospital_suspected) ~ Hospital_total)) %>%
#   select(date, contains("ICU"), everything()) %>%
#   mutate(date = date - days(1))
# 
# data_hosp_icu <- data_hosp %>%
#   select(date, contains("ICU")) %>%
#   pivot_longer(cols = c(ICU_confirmed, ICU_suspected, ICU_confsusp), names_to = "Patients", values_to = "Number") %>%
#   mutate(Patients = recode(Patients,  "ICU_confsusp" = "Confirmed/Suspected", 
#                            "ICU_confirmed" = "Confirmed", 
#                            "ICU_suspected" = "Suspected")) %>%
#   mutate(Patients = factor(Patients, levels = c("Confirmed/Suspected", "Suspected", "Confirmed")))
# 
# 
# 
# data_hosp_hosp <- data_hosp %>%
#   select(date, contains("hospital")) %>%
#   pivot_longer(cols = c(Hospital_confirmed, Hospital_suspected, Hospital_confsusp), names_to = "Patients", values_to = "Number") %>%
#   mutate(Patients = recode(Patients,  "Hospital_confsusp" = "Confirmed/Suspected", 
#                            "Hospital_confirmed" = "Confirmed", 
#                            "Hospital_suspected" = "Suspected")) %>%
#   mutate(Patients = factor(Patients, levels = c("Confirmed/Suspected", "Suspected", "Confirmed")))

wk_gr_hosp_icu <- data_hosp %>%
       mutate(ICU_prev = lag(ICU_total , 7), 
         weekdays(date)) %>%
       filter(date >= ymd("2020-03-25")) %>%
       #pivot_longer(c(ICU_total, ICU_prev), names_to = "week", values_to = "number") %>%
      group_by(date) %>%
      nest() %>%
      mutate(tab = map(data, ~ weekly_ratios_ci(.x$ICU_total, .x$ICU_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1)


wk_gr_hosp_icu_latest <- filter(wk_gr_hosp_icu, date == max(wk_gr_hosp_icu$date))

wk_gr_hosp_hosp <- data_hosp %>%
       mutate(Hosp_prev = lag(Hospital_total , 7), 
         weekdays(date)) %>%
       filter(date >= ymd("2020-03-25")) %>%
       #pivot_longer(c(Hospital_total, Hosp_prev), names_to = "week", values_to = "number") %>%
      group_by(date) %>%
      nest() %>%
      mutate(tab = map(data, ~ weekly_ratios_ci(.x$Hospital_total, .x$Hosp_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1)

# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$ratio_under_1)
# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$ratio_under_1)
# 
# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$significance)
# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$ratio_under_1)

# table(filter(wk_gr_hosp_icu, date >= max(ymd(wk_gr_hosp_icu$date))-20)$significance)
# table(filter(wk_gr_hosp_icu, date >= max(ymd(wk_gr_hosp_icu$date))-20)$ratio_under_1)

wk_gr_hosp_hosp_latest <- filter(wk_gr_hosp_hosp, date == max(wk_gr_hosp_icu$date))

# Import NRS data
#myurl_deaths <- "https://www.nrscotland.gov.uk/files//statistics/covid19/covid-deaths-data-week-37.xlsx"
myurl_deaths <- "https://www.nrscotland.gov.uk/files//statistics/covid19/covid-deaths-data-week-41.xlsx"
GET(myurl_deaths, write_disk(tmp <- tempfile(fileext = ".xlsx")))
GET(myurl_deaths, write_disk("nrs.xlsx", overwrite = TRUE))


#NRS weekly
nrs_deaths_covid_raw <- read_excel(tmp, sheet = "Table 1", skip = 3) %>%
  select(-`Year to Date`) %>%
  rename("Details" = "...2",
         "Total" = "...45")
nrs_deaths_covid <- nrs_deaths_covid_raw %>% filter(`Week beginning` == "Deaths involving COVID-194") %>%
  pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  mutate(Type = "Covid19 deaths") %>%
  select(week_beginning, weekly_deaths_total, Type)


#NRS weekly
# nrs_deaths_covid_raw <- read_excel(tmp, sheet = "Table 1", skip = 3) %>%
#   select(-`Year to Date`) %>%
#   rename("Details" = "...2",
#          "Total" = "...36")
# 
# nrs_deaths_covid <- nrs_deaths_covid_raw %>% filter(`Week beginning` == "Deaths involving COVID-194") %>%
#   pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
#                names_to = "week_beginning", 
#                values_to = "weekly_deaths_total") %>%
#   mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
#   mutate(Type = "Covid19 deaths") %>%
#   select(week_beginning, weekly_deaths_total, Type)

# NRS daily
nrs_deaths_covid_raw_daily <- read_excel(tmp, sheet = "Figure 2 data", skip =2) %>%
  filter(!is.na(Source)) %>%
  mutate(date = janitor::excel_numeric_to_date(parse_number(Date1))) %>%
  filter(Source == "NRS") %>%
  mutate(new_deaths = c(0,diff(`Cumulative Count`, 1))) 

#Holidays to adjust
# Monday/Tuesday death numbers that can be adjusted are: 13/14 April, 4/5 May, 18/19 May (Victoria day), and for the future 25/26 May (Whitsun). We may also see an effect for 8/9 June (Queenâ€™s official birthday)
#The will affect ratios for 13/20/27 April, 4/11/18/25 May and 1/8 June. 

bank_hol <- dmy(c("13/4/2020", "14/4/2020","04/05/2020", "05/05/2020", "18/05/2020", "19/05/2020", "25/05/2020", "26/05/2020"))

# NRS daily adjust bank holiday effect
nrs_deaths_covid_raw_daily <- nrs_deaths_covid_raw_daily %>%
  mutate(dow = weekdays(date)) %>%
  mutate(bank_hol = if_else(date %in% bank_hol, "Yes", "No"))

nrs_deaths_covid_raw_daily_montues <- nrs_deaths_covid_raw_daily %>%
  filter(dow %in% c("Monday", "Tuesday"))

nrs_non_hol_perc <- nrs_deaths_covid_raw_daily_montues %>% 
  filter(bank_hol == "No") %>%
  group_by(dow) %>%
  summarise(new_deaths_tot = sum(new_deaths)) %>%
  mutate(perc = new_deaths_tot/sum(new_deaths_tot))
  
nrs_deaths_covid_raw_daily_adj <- nrs_deaths_covid_raw_daily_montues %>% 
  filter(bank_hol == "Yes") %>%
  mutate(week_no = week(date)) %>%
  group_by(week_no) %>%
  mutate(new_deaths_tot = sum(new_deaths)) %>%
  mutate(new_deaths_adj = case_when(dow == "Monday" ~ new_deaths_tot*nrs_non_hol_perc$perc[1], 
                                   dow == "Tuesday" ~ new_deaths_tot*nrs_non_hol_perc$perc[2])) %>%
  ungroup() %>%
  select(date, new_deaths_adj)

nrs_deaths_covid_raw_daily <- left_join(nrs_deaths_covid_raw_daily, nrs_deaths_covid_raw_daily_adj, by = "date") %>%
  mutate(new_deaths_adj = coalesce(new_deaths_adj,new_deaths)) 

#NRS HB weekly deaths
nrs_deaths_covid_hb <- nrs_deaths_covid_raw %>% slice(33:46) %>%
  #c("Ayrshire and Arran","Borders",  "Dumfries and Galloway", "Fife","Forth Valley", "Grampian", "Greater Glasgow and Clyde" , "Highland" , "Lanarkshire", "Lothian","Orkney", "Shetland" ,"Tayside", "Western Isles")
  pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  mutate(Type = "Covid19 deaths") %>%
  rename("health_board" = Details) %>%
  select(health_board, week_beginning, weekly_deaths_total, Type) %>%
  mutate(week_ending = week_beginning + 6) %>%
  mutate(health_board = str_replace(health_board, "and ", "& ")) %>%
  left_join(hb_pop, by = "health_board") %>%
  mutate(new_deaths_10000 = 10000*weekly_deaths_total/Pop_Size) %>%
  group_by(health_board) %>%
  mutate(weekly_deaths_total_prev = lag(weekly_deaths_total , 1)) %>%
  mutate(symbol = case_when(weekly_deaths_total_prev == 0 & weekly_deaths_total >0 ~ "*"))

wk_gr_nrs_deaths_hb <- nrs_deaths_covid_hb %>%
  filter(!health_board %in% c("Orkney", "Western Isles", "Shetland")) %>%
  group_by(health_board) %>%
  mutate(week_ending_prev = lag(weekly_deaths_total, 1)) %>%
  filter(!is.na(week_ending_prev) & week_ending_prev >0) %>% 
  #pivot_longer(c(weekly_deaths_total,week_ending_prev), names_to = "week", values_to = "new_numbers_week") %>%
  #mutate(week = factor(week, levels = c("week_ending_prev", "weekly_deaths_total"))) %>%
  ungroup() %>%
  group_by(health_board, week_ending) %>%
  nest() %>%
  mutate(tab = map(data, ~ weekly_ratios_ci(.x$weekly_deaths_total, .x$week_ending_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(health_board, week_ending, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  rename(date = week_ending)


# Import Scottish covid data
#path <- "COVID-19_Scotland_data_all_2020-04-10.xlsx" 
#path <- paste0("Daily_Reports/COVID-19_Scotland_data_all_", {Sys.Date()-22}, ".xlsx") 
# Scottish cases data
# scot_data_raw <- read_excel(path, sheet = "Cases By Health Board", skip = 1)
# scot_data_raw <- filter(scot_data_raw, !Health_Board %in% c("Increase", "pIncrease")) %>%
#               rename(confirmed_cases= Total,
#                      Date = Health_Board) %>%
#               mutate(date = lubridate::ymd(Date)) %>%
#               select(-Date) 
#   
# scot_data_raw$date[nrow(scot_data_raw)] <- scot_data_raw$date[nrow(scot_data_raw)-1] + days(1)
# #scot_data_raw$confirmed_cases[nrow(scot_data_raw)] <- 4565 ## REMOVE
# 
# scot_data_raw <- scot_data_raw %>%
#               mutate(date = date - days(1))
# 
# scot_data <- scot_data_raw %>%
#              mutate(new_cases = confirmed_cases - replace_na(lag(confirmed_cases),0)) #%>%
#              #mutate(doubling_time_week = 7*log(2)/log(confirmed_cases/replace_na(lag(confirmed_cases,7),0))) 

scot_tests <- read_excel(tmp_hps, sheet = "Table 5 - Testing", skip = 3) %>%
           rename("Date" = "...1",
                  "Posrate_PHS" = "...6") %>%
  rename(total_people_tested = Total) %>%
  mutate(new_people_tested = total_people_tested - lag(total_people_tested)) %>%
  mutate(new_cases = `Daily...5`) %>%
  #mutate(total_daily_tests = `Total daily tests`) %>%
  mutate(date = lubridate::ymd(Date)) %>%
  mutate(positive_perc = 100*new_cases/new_people_tested) %>%
  select(-Date) %>%
 select(date, new_cases, new_people_tested, total_people_tested, positive_perc, Posrate_PHS) %>%
  #filter(date < Sys.Date()) %>% #remove today's data
  mutate(date = date - days(1))



scot_data <- read_excel(tmp_hps, sheet = "Table 5 - Testing", skip = 3) %>%
           rename("Date" = "...1", 
         "confirmed_cases" = "Positive"
         ) %>%
  mutate(new_cases = `Daily...5`) %>%
  mutate(date = lubridate::ymd(Date)) %>%
  select(-Date) %>%
  select(date, new_cases, confirmed_cases) %>%
  #filter(date < Sys.Date()) %>% #remove today's data
mutate(date = date - days(1)) %>%
  mutate(date = case_when(new_cases == 1118 & date == ymd("2020-11-12") ~ ymd("2020-11-13"),
                          TRUE~ date))

# PHS cases adjust bank holiday effect
scot_data <- scot_data %>%
  mutate(dow = weekdays(date)) %>%
  mutate(bank_hol = if_else(date %in% bank_hol, "Yes", "No"))

scot_data_montues <- scot_data %>%
  filter(dow %in% c("Monday", "Tuesday"))

cases_non_hol_perc <- scot_data_montues %>% 
  filter(bank_hol == "No") %>%
  group_by(dow) %>%
  summarise(new_cases_tot = sum(new_cases)) %>%
  mutate(perc = new_cases_tot/sum(new_cases_tot))
  
scot_data_adj <- scot_data_montues %>% 
  filter(bank_hol == "Yes") %>%
  mutate(week_no = week(date)) %>%
  group_by(week_no) %>%
  mutate(new_cases_tot = sum(new_cases)) %>%
  mutate(new_cases_adj = case_when(dow == "Monday" ~ new_cases_tot*cases_non_hol_perc$perc[1], 
                                   dow == "Tuesday" ~ new_cases_tot*cases_non_hol_perc$perc[2])) %>%
  ungroup() %>%
  select(date, new_cases_adj)

scot_data <- left_join(scot_data, scot_data_adj, by = "date") %>%
  mutate(new_cases_adj = coalesce(new_cases_adj,new_cases)) 

             
# Scottish death data
# scot_deaths <- read_excel(path, sheet = "Scotland Deaths", skip = 1) %>%
#   rename("deaths" = Deaths_Cum, 
#          "new_deaths" = Deaths_New) %>%
#   #mutate(doubling_time_week = 7*log(2)/log(deaths/replace_na(lag(deaths,7),0))) %>%
#   mutate(date = lubridate::ymd(Date))
#   
# 
# scot_deaths$date[nrow(scot_deaths)] <- scot_deaths$date[nrow(scot_deaths)-1] + days(1)

scot_deaths <- data_deaths %>%
  rename("deaths" = `Number of COVID-19 confirmed deaths registered to date`) %>%
  mutate(date = lubridate::ymd(Date)) %>%
  select(date, deaths) %>%
  mutate(new_deaths = c(1,diff(deaths, 1)))

#Delete this
#scot_deaths[nrow(data_deaths) + 1,] = list(as_datetime("2021-02-07"),6438,7)

scot_deaths <- scot_deaths %>%
#filter(date < Sys.Date()) %>% #remove today's data
 mutate(date = date - days(1))


# PHS deaths adjust bank holiday effect
scot_deaths <- scot_deaths %>%
  mutate(dow = weekdays(date)) %>%
  mutate(bank_hol = if_else(date %in% bank_hol, "Yes", "No"))

scot_deaths_montues <- scot_deaths %>%
  filter(dow %in% c("Monday", "Tuesday"))

non_hol_perc <- scot_deaths_montues %>% 
  filter(bank_hol == "No") %>%
  group_by(dow) %>%
  summarise(new_deaths_tot = sum(new_deaths)) %>%
  mutate(perc = new_deaths_tot/sum(new_deaths_tot))

non_hol_perc_deaths_hps <- non_hol_perc
  
scot_deaths_adj <- scot_deaths_montues %>% 
  filter(bank_hol == "Yes") %>%
  mutate(week_no = week(date)) %>%
  group_by(week_no) %>%
  mutate(new_deaths_tot = sum(new_deaths)) %>%
  mutate(new_deaths_adj = case_when(dow == "Monday" ~ new_deaths_tot*non_hol_perc$perc[1], 
                                   dow == "Tuesday" ~ new_deaths_tot*non_hol_perc$perc[2])) %>%
  ungroup() %>%
  select(date, new_deaths_adj)

scot_deaths <- left_join(scot_deaths, scot_deaths_adj, by = "date") %>%
  mutate(new_deaths_adj = coalesce(new_deaths_adj,new_deaths)) 

# # Scottish tests
# scot_tests <- read_excel(path, sheet = "CPT & DPC") 
# #scot_tests$Cases[nrow(scot_tests)] <- 4565 #REMOVE
# 
# scot_tests  <- scot_tests %>%
#   rename("Conducted" = Tests, 
#          "Total Positive" = Cases,
#          "deaths_per_case" = DPC,
#          "cases_per_test" = CPT) %>%
#   mutate("Conducted today" = Conducted - replace_na(lag(Conducted), 0)) %>%
#   mutate("Total Negative" = Conducted - `Total Positive`) %>%
#   mutate("Positive" = `Total Positive` - replace_na(lag(`Total Positive`), 0),
#          "Negative" = `Total Negative` - replace_na(lag(`Total Negative`), 0)) 
# scot_tests$Positive[scot_tests$Date == ymd("2020-03-12")] <- 24
# scot_tests$Negative[scot_tests$Date == ymd("2020-03-12")] <- 552
# 
#   
# scot_tests_long <- scot_tests %>%
# pivot_longer(cols = Positive:Negative, names_to = "Result", values_to = "Number") %>%
# mutate(Result = factor(Result, levels = c("Positive", "Negative")))


# Plot colours
#nice_blue <- palette_OkabeIto[5]
#nice_red <- palette_OkabeIto[6]  

nice_blue <- "#0072B2"
nice_red <- "#D55E00"
nice_green <- "#009E73"
nice_orange <- "#E69F00"

#The will affect ratios for 13/20/27 April, 4/11/18/25 May and 1/8 June. 
#public_hols_keep <- unique(c(c(bank_hol+days(6),
#                    bank_hol+days(7)), dmy(c("12/4/2020","13/4/2020","14/4/2020","26/4/2020", #"27/4/2020","28/4/2020", "3/5/2020","4/5/2020","5/5/2020","17/5/2020", "18/5/2020", #"19/5/2020"))))
public_hols_keep_ci <- dmy(c("13/4/2020", "20/4/2020", "27/4/2020","4/5/2020", "11/05/2020", "18/5/2020", "25/5/2020", "1/6/2020", "8/6/2020"))
public_hols_keep <- c(public_hols_keep_ci, public_hols_keep_ci+days(1), public_hols_keep_ci-days(1)) %>% sort()
public_hols_keep_line <- c(public_hols_keep_ci, public_hols_keep_ci-days(1)) %>% sort()

# Weekly Growth 
wk_gr_newcases <- scot_data %>% select(new_cases, date) %>%
      #filter(date %in% unique(scot_data$date)[1:257]) %>%
      mutate(outcome = new_cases) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "raw") %>%
       mutate(symbol = case_when(change_prev == 0 & change >0 ~ "*"))

wk_gr_newcases_adj <- scot_data %>% select(new_cases_adj, date) %>%
      mutate(outcome = new_cases_adj) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "adjusted") %>%
       mutate(ratio_m = case_when(date %in% public_hols_keep ~ ratio_m),
              lci = case_when(date %in% public_hols_keep_ci ~ lci),
              uci = case_when(date %in% public_hols_keep_ci ~ uci)) %>%
       mutate(symbol = case_when(change_prev == 0 & change >0 ~ "*"))


wk_gr_newcases_adj <- bind_rows(wk_gr_newcases, wk_gr_newcases_adj) %>% mutate(source = "PHS")

#table(filter(wk_gr_newcases, date >= max(ymd(wk_gr_newcases$date))-20)$significance)
#table(filter(wk_gr_newcases, date >= max(ymd(wk_gr_newcases$date))-20)$ratio_under_1)

wk_gr_newdeaths <- scot_deaths %>% select(new_deaths, date) %>%
      mutate(outcome = new_deaths) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       #significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "raw") %>%
       mutate(symbol = case_when(change_prev == 0 & change >0 ~ "*"))

wk_gr_newdeaths_adj <- scot_deaths %>% select(new_deaths_adj, date) %>%
      mutate(outcome = new_deaths_adj) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "adjusted") %>%
       mutate(ratio_m = case_when(date %in% public_hols_keep ~ ratio_m),
              lci = case_when(date %in% public_hols_keep_ci ~ lci),
              uci = case_when(date %in% public_hols_keep_ci ~ uci)) %>%
       mutate(symbol = case_when(change_prev == 0 & change >0 ~ "*"))

wk_gr_newdeaths_adj_mainplot <- scot_deaths %>% select(new_deaths_adj, date) %>%
      mutate(outcome = new_deaths_adj) %>%
       weekly_ratios() %>%
      mutate(ci = case_when(date %in% public_hols_keep_ci ~ "Adjusted",
                            !date %in% public_hols_keep_ci ~ "Unadjusted"),
             line =case_when(date %in% public_hols_keep_line ~ "Adjusted",
                            !date %in% public_hols_keep_line ~ "Unadjusted") ) %>%
       mutate(symbol = case_when(change_prev == 0 & change >0 ~ "*"))

wk_gr_newdeaths_adj_adj <- wk_gr_newdeaths_adj %>%
               mutate(adjusted = date %in% public_hols_keep_ci,
                      adjusted_line = date %in% public_hols_keep)

wk_gr_newdeaths_adj <- bind_rows(wk_gr_newdeaths, wk_gr_newdeaths_adj) %>% mutate(source = "PHS")

#table(filter(wk_gr_newdeaths, date >= max(ymd(wk_gr_newdeaths$date))-20)$significance)
#table(filter(wk_gr_newdeaths, date >= max(ymd(wk_gr_newdeaths$date))-20)$ratio_under_1)


wk_gr_newdeaths_nrs <- nrs_deaths_covid_raw_daily %>% select(new_deaths, date) %>%
      mutate(outcome = new_deaths) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(type = "raw")

wk_gr_newdeaths_nrs_adj <- nrs_deaths_covid_raw_daily %>% select(new_deaths_adj, date) %>%
      mutate(outcome = new_deaths_adj) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(type = "adjusted") %>%
       mutate(ratio_m = case_when(date %in% public_hols_keep ~ ratio_m),
              lci = case_when(date %in% public_hols_keep_ci ~ lci),
              uci = case_when(date %in% public_hols_keep_ci ~ uci))

wk_gr_newdeaths__nrs_adj_adj <- wk_gr_newdeaths_nrs_adj %>%
               mutate(adjusted = date %in% public_hols_keep_ci)

wk_gr_newdeaths_nrs_adj<- bind_rows(wk_gr_newdeaths_nrs, wk_gr_newdeaths_nrs_adj) %>% mutate(source = "NRS")

wk_gr_newdeaths_nrs_hps <- bind_rows(wk_gr_newdeaths %>% mutate(source = "PHS"),
wk_gr_newdeaths_nrs %>% mutate(source = "NRS"))

wk_gr_newdeaths_nrs_hps_adj <- bind_rows(wk_gr_newdeaths_adj,
wk_gr_newdeaths_nrs_adj)

#nrs by age
nrs_deaths_covid_week_age <- nrs_deaths_covid_raw %>% 
                             slice(9:15) %>%
                             pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  #mutate(Details = case_when(`Week beginning` == "Deaths involving COVID-194" ~ "All",
  #                           TRUE ~ Details)) %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  select(-`Week beginning`) %>%
  rename("Age Group" = Details) %>%
  #filter(Location != "Other institution") %>%
  select(`Age Group`, week_beginning, weekly_deaths_total) %>%
  mutate(week_ending = week_beginning + 6)

wk_gr_nrs_deaths_age <- nrs_deaths_covid_week_age %>%
  group_by(`Age Group`) %>%
  mutate(week_ending_prev = lag(weekly_deaths_total, 1)) %>%
  filter(!is.na(week_ending_prev) & week_ending_prev >0) %>% 
  ungroup() %>%
  group_by(`Age Group`, week_ending) %>%
  nest() %>%
  mutate(tab = map(data, ~ weekly_ratios_ci(.x$weekly_deaths_total, .x$week_ending_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(`Age Group`, week_ending, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  rename(date = week_ending)


#nrs by location
nrs_deaths_covid_week <- nrs_deaths_covid_raw %>% 
  filter(`Week beginning` == "Deaths involving COVID-194" | 
          Details %in% c("Care Home", "Home / Non-institution", "Hospital", "Other institution")) %>%
  pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  mutate(Details = case_when(`Week beginning` == "Deaths involving COVID-194" ~ "All",
                             TRUE ~ Details)) %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  mutate(Type = "Covid19 deaths") %>%
  rename("Location" = Details) %>%
  filter(Location != "Other institution") %>%
  select(Location, week_beginning, weekly_deaths_total, Type) %>%
  mutate(week_ending = week_beginning + 6)

wk_gr_nrs_deaths <- nrs_deaths_covid_week %>%
  group_by(Location) %>%
  mutate(week_ending_prev = lag(weekly_deaths_total, 1)) %>%
  filter(!is.na(week_ending_prev) & week_ending_prev >0) %>% 
  #pivot_longer(c(weekly_deaths_total,week_ending_prev), names_to = "week", values_to = "new_numbers_week") %>%
  #mutate(week = factor(week, levels = c("week_ending_prev", "weekly_deaths_total"))) %>%
  ungroup() %>%
  group_by(Location, week_ending) %>%
  nest() %>%
  mutate(tab = map(data, ~ weekly_ratios_ci(.x$weekly_deaths_total, .x$week_ending_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(Location, week_ending, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  rename(date = week_ending)

wk_gr_nrs_deaths <- left_join(wk_gr_nrs_deaths,
  nrs_deaths_covid_week %>% 
  filter(weekly_deaths_total >0) %>%
  rename("change" = weekly_deaths_total, 
         "date" = "week_ending") %>%
  select(change, date, Location))

wk_gr_newdeaths_latest <- wk_gr_newdeaths %>% mutate(source = "PHS", Location = "PHS") %>% filter(date == max(wk_gr_newdeaths$date))

wk_gr_nps_nrs <- bind_rows(wk_gr_newdeaths %>% mutate(source = "PHS")  %>%
                           filter(date %in% wk_gr_nrs_deaths$date), 
                           wk_gr_nrs_deaths %>% mutate(source = "NRS"))
wk_gr_nps_nrs <- wk_gr_nps_nrs %>%
                 mutate(Location = case_when( source == "PHS" ~ source, 
                                              Location == "All" ~ "NRS",
                                             TRUE ~ Location))


# Import Age group data
data_agr <- read_csv("https://www.opendata.nhs.scot/dataset/b318bddf-a4dc-4262-971f-0ba329e09b87/resource/9393bd66-5012-4f01-9bc5-e7a10accacf4/download/trend_agesex_20201105.csv")

data_agr_total <- data_agr %>%
  filter(Sex == "Total" & AgeGroup != "Total") %>%
  mutate(date = lubridate::ymd(Date)) %>%
  select(-Date) %>%
  rename("new_cases" = "DailyPositive", 
         "confirmed_cases" = "CumulativePositive",
         "new_deaths" = "DailyDeaths",
         "deaths" = "CumulativeDeaths") #%>%
  #filter(date < (Sys.Date()-days(1))) #remove today's data

# data_agr_total %>%
#   group_by(date) %>%
#   summarise(total_new = sum(new_cases)) %>%
#   arrange(desc(date)) %>%
#   slice(1:60) %>% View()

wk_gr_newcases_agr <- data_agr_total %>% rename("outcome" = new_cases) %>%
  arrange(date) %>%
  group_by(AgeGroup) %>%
  nest() %>%
  mutate(gr = map(data, ~weekly_ratios(.x))) %>%
  unnest(gr) %>%
  filter(date >= ymd("2020-03-23")) %>%
  filter(!is.na(ratio) & !is.infinite(ratio))  %>%
  significance_wk() 


# Import CA data
data_ca <- read_csv("https://www.opendata.nhs.scot/dataset/b318bddf-a4dc-4262-971f-0ba329e09b87/resource/427f9a25-db22-4014-a3bc-893b68243055/download/trend_ca_20201027.csv")

# ca_map <- sf::read_sf("/Users/smazeri/Documents/GitHub/COVID-19/covid_19/infuse_dist_lyr_2011/infuse_dist_lyr_2011.shp")
# ca_map$geo_label <- recode(ca_map$geo_label, "Edinburgh, City of" = "City of Edinburgh",
#                                               "Eilean Siar" =   "Na h-Eileanan Siar")
# ca_map <- filter(ca_map, geo_label %in% unique(data_ca$CAName))
# ca_map_simp <- st_simplify(ca_map, preserveTopology = TRUE, dTolerance = 1000)
# 
# save(ca_map_simp, file= "ca_map_simp.rda" )
load("ca_map_simp.rda") 
 
ca_pop <- read_csv("/Users/gcalder2/OneDrive - University of Edinburgh/GitRepos/COVID-19/covid_19/council-area-profiles-dataset-with-copyright/council-area-profiles-dataset-with-copyright_population-estimates.csv") %>%
  filter(Year == 2019)

ca_pop <- ca_pop %>%
  group_by(`Council area`) %>%
  mutate(`Council area` = recode(`Council area`, "Dumfries and Galloway" = "Dumfries & Galloway",
         "Argyll and Bute" = "Argyll & Bute",
         "Perth and Kinross" = "Perth & Kinross")) %>%
  summarise(Pop = sum(Population))

ca2hb <- read_csv("ca2healthboard_completed.csv") %>%
         arrange(Health_board, CA)

data_ca <- data_ca %>%
  mutate(date = lubridate::ymd(Date)) %>%
  select(-Date) %>%
  rename("new_cases" = "DailyPositive", 
         "confirmed_cases" = "CumulativePositive",
         "new_deaths" = "DailyDeaths",
         "deaths" = "CumulativeDeaths") %>%
  left_join(ca2hb, by = c("CAName" = "CA")) %>%
  left_join(ca_pop, by = c("CAName" = "Council area")) %>%
  mutate(CAName = factor(CAName, levels = ca2hb$CA)) %>%
  mutate(new_cases_pop_100000 = 100000*new_cases/Pop,
new_deaths_pop_100000 = 100000*new_deaths/Pop) #%>%
  #filter(date < (Sys.Date()-days(1)))  #remove today's data


wk_gr_newcases_ca <- data_ca %>% rename("outcome" = new_cases) %>%
  arrange(date) %>%
  group_by(CAName) %>%
  nest() %>%
  mutate(gr = map(data, ~weekly_ratios(.x))) %>%
  unnest(gr) %>%
  filter(date >= ymd("2020-03-23")) %>%
  #filter(!is.na(ratio) & !is.infinite(ratio))  %>%
  significance_wk() 

ca_map_simp <- left_join(ca_map_simp, wk_gr_newcases_ca, by = c("geo_label" = "CAName"))
#write_csv(x= data.frame(CA = unique(data_ca$CAName), Health_board = ""),
#          "ca2healthboard.csv")

# Import HB data
url_hps_hb <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/coronavirus-covid-19-trends-in-daily-data/documents/covid-19-data-by-nhs-board/covid-19-data-by-nhs-board/govscot%3Adocument/COVID--19%2Bdata%2Bby%2BNHS%2BBoard%2B16%2BMay%2B2020.xlsx?forceDownload=true"
GET(url_hps_hb, write_disk(tmp <- tempfile(fileext = ".xlsx")))
GET(url_hps_hb, write_disk("hps_daily_hb.xlsx", overwrite = TRUE))

# HB CASES
hb_cases <- read_excel(tmp, sheet = "Table 1 - Cumulative cases", skip = 2) %>%
            select(-Scotland) %>%
            mutate(date = lubridate::ymd(`Date notified`)) %>%
           select(-`Date notified`) %>%
            pivot_longer(cols = `NHS Ayrshire & Arran`:`NHS Western Isles`, names_to = "health_board", values_to = "confirmed_cases") %>%
           filter(confirmed_cases != "*") %>%
           mutate(health_board = str_remove(health_board, "NHS ")) %>%
           #mutate(confirmed_cases = case_when(confirmed_cases == "*" ~ 0,
           #                                   TRUE ~ confirmed_cases)) %>%
           group_by(health_board) %>%
           mutate(new_cases = parse_number(confirmed_cases) - parse_number(replace_na(lag(confirmed_cases),0))) %>%
           mutate(date = date - days(1)) %>%
  ungroup() %>%
  left_join(hb_pop, by = "health_board") %>%
  mutate(new_cases_10000 = 10000*new_cases/Pop_Size) %>%
  group_by(health_board) %>%
  mutate(change = roll_sumr(new_cases, n = 7),
         change_prev = lag(change, n = 7)) %>%
  mutate(symbol = case_when(change_prev == 0 & change >0 ~ "*"))

health_boards <- unique(hb_cases$health_board)

wk_gr_newcases_hb <- hb_cases %>% rename("outcome" = new_cases) %>%
  mutate(outcome = case_when(outcome < 0 ~ 0,
                             TRUE ~ outcome)) %>%
  arrange(date) %>%
  group_by(health_board) %>%
  nest() %>%
  mutate(gr = map(data, ~weekly_ratios(.x))) %>%
  unnest(gr) %>%
  filter(date >= ymd("2020-03-23")) %>%
  filter(!is.na(ratio) & !is.infinite(ratio))  %>%
  significance_wk() 

# HB deaths
hb_casesdeaths <- read_csv("https://www.opendata.nhs.scot/dataset/b318bddf-a4dc-4262-971f-0ba329e09b87/resource/2dd8534b-0a6f-4744-9253-9565d62f96c2/download/trend_hb_20201028.csv")

hb_casesdeaths <- hb_casesdeaths %>%
  mutate(health_board = str_remove(HBName, "NHS ")) %>%
  mutate(date = lubridate::ymd(Date)) %>%
           select(-Date)

#HB ICU
hb_icu <- read_excel(tmp, sheet = "Table 2 - ICU patients", skip = 2) %>%
           select(-`Scotland total`, -`Golden Jubilee National Hospital` ) %>%
           mutate(date = lubridate::ymd(`Reporting date`)) %>%
           select(-`Reporting date`) %>%
           mutate_if(is.numeric,as.character, is.factor, as.character) %>%
           pivot_longer(cols = `NHS Ayrshire & Arran`:`NHS Western Isles`, names_to = "health_board", values_to = "ICU_total") %>%
           mutate(ICU_total_or = ICU_total) %>%
           #mutate(ICU_total = str_replace(ICU_total, "\\*", "2")) %>%
           mutate(ICU_total = parse_number(ICU_total)) %>%
           mutate(health_board = str_remove(health_board, "NHS ")) %>%
           mutate(date = date - days(1)) %>%
  left_join(hb_pop, by = "health_board") %>%
  mutate(ICU_total_10000 = 10000*ICU_total/Pop_Size) %>%
  group_by(health_board) %>%
  mutate(ICU_prev = lag(ICU_total , 7)) %>%
  mutate(symbol = case_when(is.na(ICU_prev) & ICU_total >0 ~ "*"))

hb_icu_keep <- hb_icu %>%
  group_by(health_board) %>%
  summarise(prop_asterisk = sum(ICU_total_or=="*")/ n()) %>%
  arrange(prop_asterisk) %>%
  filter(prop_asterisk < 0.45) %>%
  .$health_board


wk_gr_hosp_icu_hb <- hb_icu %>%
         filter(health_board %in% hb_icu_keep) %>%
         replace_with_na(replace = list(ICU_total = "*")) %>%
         group_by(health_board) %>%
         mutate(ICU_prev = lag(ICU_total , 7), 
         weekdays(date)) %>%
         filter(date >= ymd("2020-03-25")) %>%
         ungroup() %>%
         group_by(health_board, date) %>%
         nest() %>%
  mutate(tab = map(data, ~ weekly_ratios_ci(.x$ICU_total, .x$ICU_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(health_board, date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  #significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1)

#HB HOSPITAL
hb_hosp_conf <- read_excel(tmp, sheet = "Table 3 - Hospital patients", skip = 2) %>%
                select(-Scotland, -`Golden Jubilee National Hospital` ) %>%
                mutate(date = lubridate::ymd(`Reporting date`)) %>%
           select(-`Reporting date`) %>%
           mutate_if(is.numeric,as.character, is.factor, as.character) %>%
           pivot_longer(cols = `NHS Ayrshire & Arran`:`NHS Western Isles`, names_to = "health_board", values_to = "Hosp_confirmed") %>%
           mutate(Hosp_confirmed_or = Hosp_confirmed) %>%
           #mutate(Hosp_confirmed = str_replace(Hosp_confirmed, "\\*", "2")) %>%
           mutate(Hosp_confirmed = parse_number(Hosp_confirmed)) %>%
           mutate(health_board = str_remove(health_board, "NHS ")) %>% #%>%
           #mutate(Hosp_confirmed = replace_na(Hosp_confirmed, 2))
           mutate(date = date - days(1)) %>%
  left_join(hb_pop, by = "health_board") %>%
  mutate(Hosp_confirmed_10000 = 10000*Hosp_confirmed/Pop_Size) %>%
  group_by(health_board) %>%
  mutate(Hosp_confirmed_prev = lag(Hosp_confirmed , 7)) %>%
  mutate(symbol = case_when(is.na(Hosp_confirmed_prev) & Hosp_confirmed >0 ~ "*"))

hb_hosp_total <- hb_hosp_conf

# hb_hosp_susp <- read_excel(tmp, sheet = "Table 3b- Hospital Suspected", skip =2) %>%
#            select(-Scotland, -`Golden Jubilee National Hospital` ) %>%
#            mutate(date = lubridate::ymd(Date)) %>%
#            select(-Date) %>%
#            mutate_if(is.numeric,as.character, is.factor, as.character) %>%
#            pivot_longer(cols = `NHS Ayrshire & Arran`:`NHS Western Isles`, names_to = "health_board", values_to = "Hosp_suspected") %>%
#            mutate(Hosp_suspected = parse_number(Hosp_suspected)) %>%
#            mutate(health_board = str_remove(health_board, "NHS ")) %>%
#            mutate(Hosp_suspected = case_when(health_board == "Greater Glasgow & Clyde" ~ 0, 
#                                              TRUE ~ Hosp_suspected)) %>%
#            mutate(date = date - days(1))
# 
# hb_hosp_total <- left_join(hb_hosp_conf, hb_hosp_susp) %>%
#                  mutate(Hosp_total = Hosp_confirmed + Hosp_suspected)

hb_hosp_keep <- hb_hosp_conf %>%
  group_by(health_board) %>%
  summarise(prop_asterisk = sum(Hosp_confirmed_or=="*")/ n()) %>%
  arrange(prop_asterisk) %>%
  filter(prop_asterisk < 0.45) %>%
  .$health_board

wk_gr_hosp_hosp_hb <- hb_hosp_conf %>%
         filter(health_board %in% hb_hosp_keep) %>%
         group_by(health_board) %>%
         mutate(Hosp_prev = lag(Hosp_confirmed , 7), 
         weekdays(date)) %>%
         filter(date >= ymd("2020-03-25")) %>%
         ungroup() %>%
         group_by(health_board, date) %>%
         nest() %>%
  mutate(tab = map(data, ~ weekly_ratios_ci(.x$Hosp_confirmed, .x$Hosp_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(health_board, date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1)

```

```{r, results="hide"}
#dmy("23/3/2020") + days(14)
#dmy("23/3/2020") + days(21)
#dmy("23/3/2020") + days(28)
#dmy("23/3/2020") + days(35)
count_deaths_6thApril <- filter(scot_deaths, date >= (dmy("23/3/2020") + days(14)))
count_deaths_13thApril <- filter(scot_deaths, date >= (dmy("23/3/2020") + days(21)))
count_deaths_20thApril <- filter(scot_deaths, date >= (dmy("23/3/2020") + days(28)))
count_deaths_27thApril <- filter(scot_deaths, date >= (dmy("23/3/2020") + days(35)))
sum(count_deaths_20thApril$new_deaths)
sum(count_deaths_6thApril$new_deaths)

data.frame(Days_after_lockdown = c(14,21,28,35),
           Starting_date = c(min(count_deaths_6thApril$date),
                               min(count_deaths_13thApril$date),
                               min(count_deaths_20thApril$date),
                               min(count_deaths_27thApril$date)),
           End_date = max(count_deaths_6thApril$date),
           Number_of_Deaths = c(sum(count_deaths_6thApril$new_deaths), 
                                  sum(count_deaths_13thApril$new_deaths), 
                                  sum(count_deaths_20thApril$new_deaths), 
                                  sum(count_deaths_27thApril$new_deaths)),
           Total_Deaths = sum(scot_deaths$new_deaths)) %>%
          mutate(Percentage = round(100* Number_of_Deaths/Total_Deaths,1)) %>%
  write_csv("percentage_deaths.csv")
```


```{r}
## Comparison numbers
# Cases
cases_comp <- filter(wk_gr_newcases, date %in% c(max(wk_gr_newcases$date), max(wk_gr_newcases$date)-21)) %>%
  mutate(dow = weekdays(date))

dcl_inc <- ifelse(cases_comp$change[2] - cases_comp$change[1] > 0, "increased", "declined")
fall_inc <- ifelse(cases_comp$change[2] - cases_comp$change[1] > 0, "an increase", "a fall")
fall_inc_no <- 100*abs(cases_comp$change[2] - cases_comp$change[1])/cases_comp$change[1]
fall_inc_no <- formatC(round(fall_inc_no,2), format='f', digits=1)

# Deaths HPS
deaths_hps_comp <- filter(wk_gr_newdeaths, date %in% c(max(wk_gr_newdeaths$date), max(wk_gr_newdeaths$date)-21)) %>%
  mutate(dow = weekdays(date))

dcl_inc_hps <- ifelse(deaths_hps_comp$change[2] - deaths_hps_comp$change[1] > 0, "increased", "declined")
fall_inc_hps <- ifelse(deaths_hps_comp$change[2] - deaths_hps_comp$change[1] > 0, "an increase", "a fall")
fall_inc_no_hps <- 100*abs(deaths_hps_comp$change[2] - deaths_hps_comp$change[1])/deaths_hps_comp$change[1]
fall_inc_no_hps <- formatC(round(fall_inc_no_hps,2), format='f', digits=1)

# Deaths NRS
deaths_nrs_comp <- filter(wk_gr_newdeaths_nrs, date %in% c(max(wk_gr_newdeaths_nrs$date), max(wk_gr_newdeaths_nrs$date)-21)) %>%
  mutate(dow = weekdays(date))

dcl_inc_nrs <- ifelse(deaths_nrs_comp$change[2] - deaths_nrs_comp$change[1] > 0, "increased", "declined")
fall_inc_nrs <- ifelse(deaths_nrs_comp$change[2] - deaths_nrs_comp$change[1] > 0, "an increase", "a fall")
fall_inc_no_nrs <- 100*abs(deaths_nrs_comp$change[2] - deaths_nrs_comp$change[1])/deaths_nrs_comp$change[1]
fall_inc_no_nrs <- formatC(round(fall_inc_no_nrs,2), format='f', digits=1)

# Hosp hosp icu
hosp_comp <- filter(data_hosp, date %in% c(max(data_hosp$date), max(data_hosp$date)-21)) %>%
  mutate(dow = weekdays(date))

dcl_inc_hosp <- ifelse(hosp_comp$Hospital_confirmed[2] - hosp_comp$Hospital_confirmed[1] > 0, "increased", "declined")
fall_inc_hosp <- ifelse(hosp_comp$Hospital_confirmed[2] - hosp_comp$Hospital_confirmed[1] > 0, "an increase", "a fall")
fall_inc_no_hosp <- 100*abs(hosp_comp$Hospital_confirmed[2] - hosp_comp$Hospital_confirmed[1])/hosp_comp$Hospital_confirmed[1]
fall_inc_no_hosp <- formatC(round(fall_inc_no_hosp,2), format='f', digits=1)

dcl_inc_icu <- ifelse(hosp_comp$ICU_total[2] - hosp_comp$ICU_total[1] > 0, "increased", "declined")
fall_inc_icu <- ifelse(hosp_comp$ICU_total[2] - hosp_comp$ICU_total[1] > 0, "an increase", "a fall")
fall_inc_no_icu <- 100*abs(hosp_comp$ICU_total[2] - hosp_comp$ICU_total[1])/hosp_comp$ICU_total[1]
fall_inc_no_icu <- formatC(round(fall_inc_no_icu,2), format='f', digits=1)
```


The number of cases over the past 7 days has `r dcl_inc` to `r cases_comp$change[2]` today from `r cases_comp$change[1]` three weeks previously, `r fall_inc` of `r fall_inc_no`%.

The number of deaths recorded by HPS over the past 7 days has `r dcl_inc_hps` to `r deaths_hps_comp$change[2]` today from `r deaths_hps_comp$change[1]` three weeks previously, `r fall_inc_hps` of `r fall_inc_no_hps`%.

The number of deaths recorded by NRS over the past 7 days has `r dcl_inc_nrs` to `r deaths_nrs_comp$change[2]` today from `r deaths_nrs_comp$change[1]` three weeks previously, `r fall_inc_nrs` of `r fall_inc_no_nrs`%.

The number of patients in hospital with confirmed COVID-19 on `r format(max(data_hosp$date), '%d/%m/%Y')` has `r dcl_inc_hosp` to `r hosp_comp$Hospital_confirmed[2]` today from `r hosp_comp$Hospital_confirmed[1]` three weeks previously, `r fall_inc_hosp` of `r fall_inc_no_hosp`%.

The number of patients in ICU with confirmed or suspect COVID-19 on `r format(max(data_hosp$date), '%d/%m/%Y')` has `r dcl_inc_icu` to `r hosp_comp$ICU_total[2]` today from `r hosp_comp$ICU_total[1]` three weeks previously, `r fall_inc_icu` of `r fall_inc_no_icu`%.


### Over the last 21 days...

### Cases
```{r}
table(filter(wk_gr_newcases, date >= max(ymd(wk_gr_newcases$date))-20)$ratio_under_1) %>% kable(caption = "Ratio under 1")
table(filter(wk_gr_newcases, date >= max(ymd(wk_gr_newcases$date))-20)$significance) %>% kable(caption = "Significance")
```

### Deaths HPS
```{r}
table(filter(wk_gr_newdeaths, date >= max(ymd(wk_gr_newdeaths$date))-20)$ratio_under_1) %>% kable(caption = "Ratio under 1")
table(filter(wk_gr_newdeaths, date >= max(ymd(wk_gr_newdeaths$date))-20)$significance) %>% kable(caption = "Significance")
```

### Hospital
```{r}
table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$ratio_under_1) %>% kable(caption = "Ratio under 1")
table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$significance)  %>% kable(caption = "Significance")
```

### ICU
```{r}
table(filter(wk_gr_hosp_icu, date >= max(ymd(wk_gr_hosp_icu$date))-20)$ratio_under_1) %>% kable(caption = "Ratio under 1")
table(filter(wk_gr_hosp_icu, date >= max(ymd(wk_gr_hosp_icu$date))-20)$significance)  %>% kable(caption = "Significance")
```
