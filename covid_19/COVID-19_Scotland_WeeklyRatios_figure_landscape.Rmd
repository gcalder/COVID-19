---
title: "Monitoring the Covid-19 Pandemic in Scotland"
date: "`r format(Sys.time(), '%d %B, %Y')`" 
header-includes:
   - \usepackage{booktabs}
   - \usepackage{float}
   - \floatplacement{figure}{H}
   - \usepackage{caption}
   - \captionsetup[figure]{labelformat=empty}
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: no
classoption: landscape
---

```{r setup, include=FALSE}
#date: "`r format(Sys.time(), '%d %B, %Y')`" 
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.pos = 'H')
# Load packages
library(flexdashboard) ; library(shiny) ; library(readr); library(dplyr); library(tidyr); library(purrr); library(forcats); library(stringr); library(htmlwidgets); library(lubridate); library(sf); library(RcppRoll); library(plotly); library(shinythemes);library(leaflet); library(classInt); library(ggrepel); library(scales); library(leaflet.extras); library(RColorBrewer);
library(colorblindr); library(readxl);library(spatstat.utils);library(httr);library(cowplot)

source("growth_rate_window.R")
source("weekly_ratios.R")
source("weekly_ratios_byday.R")


# Import hospital data
## Covid daily hospital data
myurl <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/documents/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/govscot%3Adocument/Data%2BTable%2B%252810-04-2020%2529.xlsx?forceDownload=true"
GET(myurl, write_disk(tmp <- tempfile(fileext = ".xlsx")))

#data_hosp <- read_excel(tmp, sheet = "Table 1", skip = 3)
data_hosp <- read_excel(tmp, sheet = "Table 2 - Hospital Care", skip = 3)

data_hosp <- data_hosp %>%
  rename("date" = "...1",
         "ICU_confirmed" = "Confirmed...2",
         "ICU_suspected" ="Suspected...3", 
         "ICU_total" = "Total...4",
         "Hospital_confirmed" = "Confirmed...5",
         "Hospital_suspected" = "Suspected...6",
         "Hospital_total" = "Total...7" ) %>%
  filter(!is.na(ICU_total)) %>%
  #mutate(date = as.Date(as.numeric(date), origin = "1899-12-30")) %>%
  mutate(date = lubridate::ymd(date)) %>%
  mutate(ICU_confsusp = case_when(is.na(ICU_confirmed) & is.na(ICU_suspected) ~ ICU_total)) %>%
  mutate(Hospital_confsusp = case_when(is.na(Hospital_confirmed) & is.na(Hospital_suspected) ~ Hospital_total)) %>%
  select(date, contains("ICU"), everything()) %>%
  select(date, ICU_total, Hospital_total) 

wk_gr_hosp_icu <- data_hosp %>%
       mutate(ICU_prev = lag(ICU_total , 7), 
         weekdays(date)) %>%
       filter(date >= ymd("2020-03-25")) %>%
       pivot_longer(c(ICU_total, ICU_prev), names_to = "week", values_to = "number") %>%
      group_by(date) %>%
      nest() %>%
      mutate(mod = map(data, ~ glm(number ~ week,
                              data = .x, family = poisson))) %>%
  mutate(ratio_m = map_dbl(mod, ~ exp(coef(.x)["weekICU_total"]))) %>% 
  mutate(lci = map_dbl(mod, ~ exp(confint(.x)["weekICU_total", "2.5 %"]))) %>%
  mutate(uci = map_dbl(mod, ~ exp(confint(.x)["weekICU_total", "97.5 %"]))) %>%
  ungroup() %>%
  select(date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() 


wk_gr_hosp_icu_latest <- filter(wk_gr_hosp_icu, date == max(wk_gr_hosp_icu$date))

wk_gr_hosp_hosp <- data_hosp %>%
       mutate(Hosp_prev = lag(Hospital_total , 7), 
         weekdays(date)) %>%
       filter(date >= ymd("2020-03-25")) %>%
       pivot_longer(c(Hospital_total, Hosp_prev), names_to = "week", values_to = "number") %>%
      group_by(date) %>%
      nest() %>%
      mutate(mod = map(data, ~ glm(number ~ week,
                              data = .x, family = poisson))) %>%
  mutate(ratio_m = map_dbl(mod, ~ exp(coef(.x)["weekHospital_total"]))) %>% 
  mutate(lci = map_dbl(mod, ~ exp(confint(.x)["weekHospital_total", "2.5 %"]))) %>%
  mutate(uci = map_dbl(mod, ~ exp(confint(.x)["weekHospital_total", "97.5 %"]))) %>%
  ungroup() %>%
  select(date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() 


wk_gr_hosp_hosp_latest <- filter(wk_gr_hosp_hosp, date == max(wk_gr_hosp_icu$date))

# Import NRS data
myurl_deaths <- "https://www.nrscotland.gov.uk/files//statistics/covid19/covid-deaths-data-week-16.xlsx"
GET(myurl_deaths, write_disk(tmp <- tempfile(fileext = ".xlsx")))
nrs_deaths_covid_raw <- read_excel(tmp, sheet = "Table 1 - COVID deaths", skip = 3) %>%
  select(-`Year to Date`) %>%
  rename("Details" = "...2",
         "Total" = "...20")

nrs_deaths_covid <- nrs_deaths_covid_raw %>% filter(`Week beginning` == "Deaths involving COVID-194") %>%
  pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  mutate(Type = "Covid19 deaths") %>%
  select(week_beginning, weekly_deaths_total, Type)

# Import Scottish covid data
#path <- "COVID-19_Scotland_data_all_2020-04-10.xlsx" 
path <- paste0("COVID-19_Scotland_data_all_", {Sys.Date()}, ".xlsx") 
# Scottish cases data
scot_data_raw <- read_excel(path, sheet = "Cases By Health Board", skip = 1)
scot_data_raw <- filter(scot_data_raw, !Health_Board %in% c("Increase", "pIncrease")) %>%
              rename(confirmed_cases= Total,
                     Date = Health_Board) %>%
              mutate(date = lubridate::ymd(Date)) %>%
              select(-Date)
  
scot_data_raw$date[nrow(scot_data_raw)] <- scot_data_raw$date[nrow(scot_data_raw)-1] + days(1)
#scot_data_raw$confirmed_cases[nrow(scot_data_raw)] <- 4565 ## REMOVE

scot_data <- scot_data_raw %>%
             mutate(new_cases = confirmed_cases - replace_na(lag(confirmed_cases),0)) %>%
             mutate(doubling_time_week = 7*log(2)/log(confirmed_cases/replace_na(lag(confirmed_cases,7),0))) 
             
# Per health board
scot_data_health_board <- scot_data %>% 
  select(date, Ayrshire:`Dumfries and Galloway`) %>%
  pivot_longer(Ayrshire:`Dumfries and Galloway`,
               names_to = "health_board",
               values_to = "confirmed_cases") %>% 
  group_by(health_board) %>%
  mutate(new_cases = confirmed_cases - replace_na(lag(confirmed_cases), 0)) %>%
  ungroup() %>%
  replace_na(list(new_cases = 0))

# Per health board for map
# Cumulative incidence
scot_ci_hb <- read_excel(path, sheet = "Cumulative Incidence Grouped") %>%
  slice(nrow(.)) %>%
  select(Ayrshire:Tayside) %>%
  pivot_longer(Ayrshire:Tayside, names_to = "health_board", values_to = "cumulative_incidence")

# Incidence over last day
scot_ti_hb <- read_excel(path, sheet = "Incidence by Health Board") %>%
  slice(nrow(.)) %>%
  select(Ayrshire:Tayside) %>%
  pivot_longer(Ayrshire:Tayside, names_to = "health_board", values_to = "today_incidence")

scot_data_health_board_total <- scot_data_health_board %>% 
                                group_by(health_board) %>%
                                summarise(confirmed_cases = max(confirmed_cases, na.rm = T)) %>%
                                left_join(scot_ci_hb)

# Scottish death data
scot_deaths <- read_excel(path, sheet = "Scotland Deaths", skip = 1) %>%
  rename("deaths" = Deaths_Cum, 
         "new_deaths" = Deaths_New) %>%
  mutate(doubling_time_week = 7*log(2)/log(deaths/replace_na(lag(deaths,7),0))) %>%
  mutate(date = lubridate::ymd(Date)) 

scot_deaths$date[nrow(scot_deaths)] <- scot_deaths$date[nrow(scot_deaths)-1] + days(1)

# Scottish tests
scot_tests <- read_excel(path, sheet = "CPT & DPC") 
#scot_tests$Cases[nrow(scot_tests)] <- 4565 #REMOVE

scot_tests  <- scot_tests %>%
  rename("Conducted" = Tests, 
         "Total Positive" = Cases,
         "deaths_per_case" = DPC,
         "cases_per_test" = CPT) %>%
  mutate("Conducted today" = Conducted - replace_na(lag(Conducted), 0)) %>%
  mutate("Total Negative" = Conducted - `Total Positive`) %>%
  mutate("Positive" = `Total Positive` - replace_na(lag(`Total Positive`), 0),
         "Negative" = `Total Negative` - replace_na(lag(`Total Negative`), 0)) 
scot_tests$Positive[scot_tests$Date == ymd("2020-03-12")] <- 24
scot_tests$Negative[scot_tests$Date == ymd("2020-03-12")] <- 552

  
scot_tests_long <- scot_tests %>%
pivot_longer(cols = Positive:Negative, names_to = "Result", values_to = "Number") %>%
mutate(Result = factor(Result, levels = c("Positive", "Negative")))


# Map files
# SCOTLAND MAP
cases_by_area <- sf::st_read("SG_NHS_HealthBoards_2019b.geojson") %>%
                 mutate(health_board = case_when(HBName == "Ayrshire and Arran" ~ "Ayrshire",
                                                 HBName %in% c("Grampian", "Shetland", "Orkney") ~ "Grampian, Shetland and Orkney",
                                                 HBName %in% c("Highland", "Western Isles") ~ "Highland and Western Isles",
                        TRUE ~ as.character(HBName))) %>%
                 st_transform(crs = st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>%
                 left_join(scot_data_health_board_total, by = c("health_board" = "health_board")) 

# Plot colours
#nice_blue <- palette_OkabeIto[5]
#nice_red <- palette_OkabeIto[6]  

nice_blue <- "#0072B2"
nice_red <- "#D55E00"
nice_green <- "#009E73"
nice_orange <- "#E69F00"

# Growth rates new cases/deaths
gr_newcases <- growth_rates(dat = scot_data %>% rename("outcome" = new_cases)) %>%
               filter(date >= ymd("2020-03-23")) %>%
               significance() %>%
  mutate(sign_ci = case_when(significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "significantly greater than 0" ~ "and the 95% confidence interval does not include zero growth",
                            significance == "significantly less than 0" ~ "and the 95% confidence interval does not include zero growth"))
gr_newdeaths <- growth_rates(dat = scot_deaths %>% rename("outcome" = new_deaths)) %>%
               filter(date >= ymd("2020-03-23")) %>%
               significance() %>%
  mutate(sign_ci = case_when(significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "significantly greater than 0" ~ "and the 95% confidence interval does not include zero growth",
                            significance == "significantly less than 0" ~ "and the 95% confidence interval does not include zero growth"))
gr_newcases_hb <- scot_data_health_board %>% rename("outcome" = new_cases) %>%
   group_by(health_board) %>%
   nest() %>%
   mutate(gr = map(data, ~growth_rates(dat = .x))) %>%
   unnest(gr) %>%
   filter(date >= ymd("2020-03-23")) %>%
               significance() %>%
  mutate(symbol = case_when(significance == "not significantly different to 0" ~ "not sig <>0",
                            significance == "not significantly different to 0" ~ "not sig <>0",
                            significance == "significantly greater than 0" ~ "sig <> 0",
                            significance == "significantly less than 0" ~ "sig <> 0")) %>%
  mutate(sign_ci = case_when(significance == "not significantly different to 0" ~ "The 95% confidence interval includes zero growth",
                            significance == "not significantly different to 0" ~ "The 95% confidence interval includes zero growth",
                            significance == "significantly greater than 0" ~ "The 95% confidence interval does not include zero growth",
                            significance == "significantly less than 0" ~ "The 95% confidence interval does not include zero growth"))

# Growth rates cumulative cases/deaths
gr_newcases_14 <- growth_rates(dat = scot_data %>% rename("outcome" = new_cases), days_n = 13) %>%
               filter(date >= ymd("2020-03-23")) %>%
               significance() %>%
  mutate(sign_ci = case_when(significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "significantly greater than 0" ~ "and the 95% confidence interval does not include zero growth",
                            significance == "significantly less than 0" ~ "and the 95% confidence interval does not include zero growth"))
gr_newdeaths_14 <- growth_rates(dat = scot_deaths %>% rename("outcome" = new_deaths), days_n = 13) %>%
               filter(date >= ymd("2020-03-23")) %>%
               significance() %>%
  mutate(sign_ci = case_when(significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "not significantly different to 0" ~ "but the 95% confidence interval includes zero growth",
                            significance == "significantly greater than 0" ~ "and the 95% confidence interval does not include zero growth",
                            significance == "significantly less than 0" ~ "and the 95% confidence interval does not include zero growth"))
gr_newcases_hb_14 <- scot_data_health_board %>% rename("outcome" = new_cases) %>%
   group_by(health_board) %>%
   nest() %>%
   mutate(gr = map(data, ~growth_rates(dat = .x, days_n = 13))) %>%
   unnest(gr) %>%
   filter(date >= ymd("2020-03-23")) %>%
               significance() %>%
  mutate(symbol = case_when(significance == "not significantly different to 0" ~ "not sig <>0",
                            significance == "not significantly different to 0" ~ "not sig <>0",
                            significance == "significantly greater than 0" ~ "sig <> 0",
                            significance == "significantly less than 0" ~ "sig <> 0")) %>%
  mutate(sign_ci = case_when(significance == "not significantly different to 0" ~ "The 95% confidence interval includes zero growth",
                            significance == "not significantly different to 0" ~ "The 95% confidence interval includes zero growth",
                            significance == "significantly greater than 0" ~ "The 95% confidence interval does not include zero growth",
                            significance == "significantly less than 0" ~ "The 95% confidence interval does not include zero growth"))


# Weekly Growth 
wk_gr_newcases <- scot_data %>% select(new_cases, date) %>%
      mutate(outcome = new_cases) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(adjustment = "no adjustment")

wk_gr_newcases_byday <- scot_data %>% select(new_cases, date) %>%
      mutate(outcome = new_cases) %>%
      mutate(dayofweek = weekdays(date)) %>%
      mutate(dayofweek = factor(dayofweek, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) %>%
       weekly_ratios_dayadj() %>%
       filter(!is.na(ratio_m) & !is.infinite(ratio_m)) %>%
       significance_wk() %>%
        mutate(adjustment = "by weekdauy")

wk_gr_newdeaths <- scot_deaths %>% select(new_deaths, date) %>%
      mutate(outcome = new_deaths) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk()

wk_gr_newcases_hb <- scot_data_health_board %>% rename("outcome" = new_cases) %>%
   group_by(health_board) %>%
   nest() %>%
   mutate(gr = map(data, ~weekly_ratios(.x))) %>%
   unnest(gr) %>%
   filter(date >= ymd("2020-03-23")) %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
    mutate(symbol = case_when(significance == "not significantly different to 1" ~ "not sig <>1",
                            significance == "not significantly different to 1" ~ "not sig <>1",
                            significance == "significantly greater than 1" ~ "sig <> 1",
                            significance == "significantly less than 1" ~ "sig <> 1")) 

nrs_deaths_covid_week <- nrs_deaths_covid_raw %>% 
  filter(`Week beginning` == "Deaths involving COVID-194" | 
          Details %in% c("Care Home", "Home / Non-institution", "Hospital", "Other institution")) %>%
  pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  mutate(Details = case_when(`Week beginning` == "Deaths involving COVID-194" ~ "All",
                             TRUE ~ Details)) %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  mutate(Type = "Covid19 deaths") %>%
  rename("Location" = Details) %>%
  filter(Location != "Other institution") %>%
  select(Location, week_beginning, weekly_deaths_total, Type) %>%
  mutate(week_ending = week_beginning + 6)

wk_gr_nrs_deaths <- nrs_deaths_covid_week %>%
  group_by(Location) %>%
  mutate(week_ending_prev = lag(weekly_deaths_total, 1)) %>%
  filter(!is.na(week_ending_prev) & week_ending_prev >0) %>% 
  pivot_longer(c(weekly_deaths_total,week_ending_prev), names_to = "week", values_to = "new_numbers_week") %>%
  mutate(week = factor(week, levels = c("week_ending_prev", "weekly_deaths_total"))) %>%
  ungroup() %>%
  group_by(Location, week_ending) %>%
  nest() %>%
  mutate(mod = map(data, ~ glm(new_numbers_week ~ week,
                              data = .x, family = poisson))) %>%
  mutate(ratio_m = map_dbl(mod, ~ exp(coef(.x)["weekweekly_deaths_total"]))) %>% 
  mutate(lci = map_dbl(mod, ~ exp(confint(.x)["weekweekly_deaths_total", "2.5 %"]))) %>%
  mutate(uci = map_dbl(mod, ~ exp(confint(.x)["weekweekly_deaths_total", "97.5 %"]))) %>%
  ungroup() %>%
  select(Location, week_ending, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  rename(date = week_ending)

wk_gr_nrs_deaths <- left_join(wk_gr_nrs_deaths,
  nrs_deaths_covid_week %>% 
  filter(weekly_deaths_total >0) %>%
  rename("change" = weekly_deaths_total, 
         "date" = "week_ending") %>%
  select(change, date, Location))

wk_gr_newdeaths_latest <- wk_gr_newdeaths %>% mutate(source = "HPS", Location = "HPS") %>% filter(date == max(wk_gr_newdeaths$date))

wk_gr_nps_nrs <- bind_rows(wk_gr_newdeaths %>% mutate(source = "HPS")  %>%
                           filter(date %in% wk_gr_nrs_deaths$date), 
                           wk_gr_nrs_deaths %>% mutate(source = "NRS"))
wk_gr_nps_nrs <- wk_gr_nps_nrs %>%
                 mutate(Location = case_when( source == "HPS" ~ source, 
                                              Location == "All" ~ "NRS",
                                             TRUE ~ Location))
  
```


\newpage

\thispagestyle{empty}

```{r casesdeathsicuratios, fig.width=5.5, fig.height= 9, fig.cap="Ratios of weekly new cases, deaths, ICU occupancy and hospitalisations vs respective counts for previous week; graphics prepared by The University of Edinburgh"}
fig1 <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        #title = "Change in weekly cases/deaths total as ratio of previous week",
        subtitle = "New Cases (Source: HPS)") +
  theme_bw(base_size = 12) #+
  #theme(axis.title.y = element_text(margin = margin(t = 0, r = 11, b = 0, l = 0)))

fig1_inset <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newcases$date)-8)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "", y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig1 <- ggdraw() +
  draw_plot(fig1) +
  draw_plot(fig1_inset, x = 0.57, y = .58, width = .40, height = .3)

fig2 <- ggplot(wk_gr_newdeaths %>% filter(!is.na(ratio) & 
              !is.infinite(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_red, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_red) +
  geom_point(colour = nice_red, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        subtitle = "New Deaths (Source: HPS)") +
  theme_bw(base_size = 12)

fig2_inset <- ggplot(wk_gr_newdeaths %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newdeaths$date)-8)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_red, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_red) +
  geom_point(colour = nice_red, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"),expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig2 <- ggdraw() +
  draw_plot(fig2) +
  draw_plot(fig2_inset, x = 0.57, y = .58, width = .40, height = .3)


fig3 <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "ICU Occupancy (Source: NHS Boards)") +
  theme_bw(base_size = 12) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 9, b = 0, l = 0)))



fig3_inset <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_icu$date)-8)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig3 <- ggdraw() +
  draw_plot(fig3) +
  draw_plot(fig3_inset, x = 0.57, y = .58, width = .40, height = .3)

fig4 <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "Hospital Occupancy (Source: NHS Boards)") +
  theme_bw(base_size = 12)


fig4_inset <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_hosp$date)-8)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig4 <- ggdraw() +
  draw_plot(fig4) +
  draw_plot(fig4_inset, x = 0.57, y = 0.58, width = 0.40, height = 0.3)

```

```{r, fig.width=15, fig.height=9, fig.cap="Ratios of new cases, new deaths, ICU occupancy and hospitalisations vs respective counts for previous time period. Cases and deaths are comparisons of weekly sums; ICU occupancy and hospitalisations are week over week comparisons of daily counts. Graphics provided by The University of Edinburgh."}
gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 2, ncol = 2) 
```

```{r, fig.width=15, fig.height=9, fig.cap="Ratios of new cases, new deaths, ICU occupancy and hospitalisations vs respective counts for previous time period. Cases and deaths are comparisons of weekly sums; ICU occupancy and hospitalisations are week over week comparisons of daily counts. Graphics provided by The University of Edinburgh."}
png("weekly_ratios_landscape.png", width = 11.69, height = 8.27, units = "in", res = 400)
#gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 2, ncol = 2, bottom = "Ratios of new cases, new deaths, hospitalisations and ICU occupancy vs respective counts for previous time period. Cases and deaths are comparisons \nof weekly sums; Hospitalisations and ICU occupancy are week over week comparisons of daily counts. Graphics provided by The University of Edinburgh.")
gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 2, ncol = 2, bottom = "Weekly ratios for new cases and new deaths are ratios of weekly sums, plotted on a log10 scale.  Day-of-the-week ratios for hospitalisations and \nICU  occupancy are ratios of daily counts, measured 7 days apart and plotted on a log10 scale. Graphics provided by The University of Edinburgh.")
dev.off()
```

```{r fig.width=5.5, fig.height= 9, fig.cap="Ratios of new cases, new deaths, ICU occupancy and hospitalisations vs respective counts for previous time period. Cases and deaths are comparisons of weekly sums; ICU occupancy and hospitalisations are week over week comparisons of daily counts. Graphics provided by The University of Edinburgh."}
fig1 <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        #title = "Change in weekly cases/deaths total as ratio of previous week",
        subtitle = "New Cases (Source: HPS)") +
  theme_bw(base_size = 12) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 14, b = 0, l = 0)))

fig1_inset <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newcases$date)-8)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "", y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig1 <- ggdraw() +
  draw_plot(fig1) +
  draw_plot(fig1_inset, x = 0.57, y = .52, width = .40, height = .3)

fig2 <- ggplot(wk_gr_newdeaths %>% filter(!is.na(ratio) & 
              !is.infinite(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_red, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_red) +
  geom_point(colour = nice_red, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        subtitle = "New Deaths (Source: HPS)") +
  theme_bw(base_size = 12)

fig2_inset <- ggplot(wk_gr_newdeaths %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newdeaths$date)-8)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_red, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_red) +
  geom_point(colour = nice_red, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"),expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig2 <- ggdraw() +
  draw_plot(fig2) +
  draw_plot(fig2_inset, x = 0.57, y = .52, width = .40, height = .3)


fig3 <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "ICU Occupancy (Source: NHS Boards)") +
  theme_bw(base_size = 12) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 7, b = 0, l = 0)))



fig3_inset <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_icu$date)-8)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig3 <- ggdraw() +
  draw_plot(fig3) +
  draw_plot(fig3_inset, x = 0.57, y = .52, width = .40, height = .3)

fig4 <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d")) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "Hospital Occupancy (Source: NHS Boards)") +
  theme_bw(base_size = 12) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 14, b = 0, l = 0)))


fig4_inset <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_hosp$date)-8)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_x_date(date_breaks = "4 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 10) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig4 <- ggdraw() +
  draw_plot(fig4) +
  draw_plot(fig4_inset, x = 0.57, y = 0.52, width = 0.40, height = 0.3)

gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 4) 
```

```{r}
png("weekly_ratios_portrait.png", height = 11.69, width = 7, units = "in", res = 400)
#gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 4, bottom = "Ratios of new cases, new deaths, hospitalisations and ICU occupancy  vs respective \ncounts for previous time period. Cases and deaths are comparisons of weekly sums; \nHospitalisations and ICU occupancy are week over week comparisons of daily counts. \nGraphics provided by The University of Edinburgh.") 
gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 4, bottom = "Weekly ratios for new cases and new deaths are ratios of weekly sums, plotted on a log10 \nscale. Day-of-the-week ratios for hospitalisations and ICU occupancy are ratios of daily \ncounts, measured 7 days apart and plotted on a log10 scale. Graphics provided by \nThe University of Edinburgh.")
dev.off()
```

```{r}
png("weekly_ratios_portrait_4email.png", height = 11.69, width = 7, units = "in", res = 400)
gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 4, bottom = "Weekly ratios for new cases and new deaths are ratios of weekly sums, plotted on a log10 \nscale. Day-of-the-week ratios for hospital occupancy and ICU occupancy are ratios of daily \ncounts, measured 7 days apart and plotted on a log10 scale. Figure insets highlight more \nrecent ratios and trends. Graphics provided by The University of Edinburgh.")
dev.off()
```




