---
title: "Monitoring the COVID-19 Pandemic in Scotland"
date: "`r format(Sys.time(), '%d %B, %Y')`" 
header-includes:
   - \usepackage{booktabs}
   - \usepackage{float}
   - \floatplacement{figure}{H}
   - \floatplacement{table}{H}
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: no
urlcolor: blue
link-citations: yes
linkcolor: black
---

<!--**Helen Brown^1^, Giles Calder-Gerver^2^, Samuel Haynes^3^, Stella Mazeri^1^, Camille A Simonet^4^, Mark Woolhouse^2,3,\*^**
\hfill \break

^1^The Roslin Institute and The Royal (Dick) School of Veterinary Studies, University of Edinburgh, Edinburgh, UK. ^2^Usher Institute, University of Edinburgh, Edinburgh, UK. ^3^School of Biological Sciences, University of Edinburgh, Edinburgh, UK. ^4^Institute of Evolutionary Biology, School of Biological Sciences, University of Edinburgh, Edinburgh, UK \newline

^\*^Email: Mark.Woolhouse@ed.ac.uk \newline -->


```{r setup, include=FALSE}
#date: "`r format(Sys.time(), '%d %B, %Y')`" 
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.pos = 'H')
# Load packages
library(flexdashboard) ; library(shiny) ; library(readr); library(dplyr); library(tidyr); library(purrr); library(forcats); library(stringr); library(htmlwidgets); library(lubridate); library(sf); library(RcppRoll); library(plotly); library(shinythemes);library(leaflet); library(classInt); library(ggrepel); library(scales); library(leaflet.extras); library(RColorBrewer);library(toOrdinal);library(knitr);library(kableExtra);library(RcppRoll);
library(colorblindr); library(readxl);library(spatstat.utils);library(httr);library(cowplot); library(viridis);
library(patchwork)

#source("growth_rate_window.R")
source("weekly_ratios_2.R")
weekly_ratios <- weekly_ratios_2
#source("weekly_ratios_byday.R")

# Import HB data
url_hps_hb <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/coronavirus-covid-19-trends-in-daily-data/documents/covid-19-data-by-nhs-board/covid-19-data-by-nhs-board/govscot%3Adocument/COVID--19%2Bdata%2Bby%2BNHS%2BBoard%2B16%2BMay%2B2020.xlsx?forceDownload=true"
GET(url_hps_hb, write_disk(tmp <- tempfile(fileext = ".xlsx")))
GET(url_hps_hb, write_disk("hps_daily_hb.xlsx", overwrite = TRUE))
hb_cases <- read_excel(tmp, sheet = "Table 1 - Cumulative cases")
hb_icu <- read_excel(tmp, sheet = "Table 2 - ICU patients")
hb_hosp_conf <- read_excel(tmp, sheet = "Table 3a - Hospital Confirmed")
hb_hosp_susp <- read_excel(tmp, sheet = "Table 3b- Hospital Suspected")

# Import hospital data
## Covid daily hospital data
myurl <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/coronavirus-covid-19-trends-in-daily-data/documents/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/govscot%3Adocument/Trends%2Bin%2Bdaily%2BCOVID-19%2Bdata%2B-%2B110520.xlsx?forceDownload=true"
#myurl <- "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/04/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/documents/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/trends-in-number-of-people-in-hospital-with-confirmed-or-suspected-covid-19/govscot%3Adocument/Data%2BTable%2B%252810-04-2020%2529.xlsx?forceDownload=true"
GET(myurl, write_disk(tmp <- tempfile(fileext = ".xlsx")))
GET(myurl, write_disk("hps_daily.xlsx", overwrite = TRUE))

#data_hosp <- read_excel(tmp, sheet = "Table 1", skip = 3)
data_hosp <- read_excel(tmp, sheet = "Table 2 - Hospital Care", skip = 3)
#data_hosp <- filter(data_hosp, `...1` != Sys.Date()) # CHANGE

data_hosp <- data_hosp %>%
  rename("date" = "...1",
         "ICU_confirmed" = "Confirmed...2",
         "ICU_suspected" ="Suspected...3", 
         "ICU_total" = "Total...4",
         "Hospital_confirmed" = "Confirmed...5",
         "Hospital_suspected" = "Suspected...6",
         "Hospital_total" = "Total...7" ) %>%
  filter(!is.na(ICU_total)) %>%
  mutate(date = lubridate::ymd(date)) %>%
  mutate(ICU_confsusp = case_when(is.na(ICU_confirmed) & is.na(ICU_suspected) ~ ICU_total)) %>%
  mutate(Hospital_confsusp = case_when(is.na(Hospital_confirmed) & is.na(Hospital_suspected) ~ Hospital_total)) %>%
  select(date, contains("ICU"), everything()) %>%
  mutate(date = date - days(1))

data_hosp_icu <- data_hosp %>%
  select(date, contains("ICU")) %>%
  pivot_longer(cols = c(ICU_confirmed, ICU_suspected, ICU_confsusp), names_to = "Patients", values_to = "Number") %>%
  mutate(Patients = recode(Patients,  "ICU_confsusp" = "Confirmed/Suspected", 
                           "ICU_confirmed" = "Confirmed", 
                           "ICU_suspected" = "Suspected")) %>%
  mutate(Patients = factor(Patients, levels = c("Confirmed/Suspected", "Suspected", "Confirmed")))



data_hosp_hosp <- data_hosp %>%
  select(date, contains("hospital")) %>%
  pivot_longer(cols = c(Hospital_confirmed, Hospital_suspected, Hospital_confsusp), names_to = "Patients", values_to = "Number") %>%
  mutate(Patients = recode(Patients,  "Hospital_confsusp" = "Confirmed/Suspected", 
                           "Hospital_confirmed" = "Confirmed", 
                           "Hospital_suspected" = "Suspected")) %>%
  mutate(Patients = factor(Patients, levels = c("Confirmed/Suspected", "Suspected", "Confirmed")))

wk_gr_hosp_icu <- data_hosp %>%
       mutate(ICU_prev = lag(ICU_total , 7), 
         weekdays(date)) %>%
       filter(date >= ymd("2020-03-25")) %>%
       #pivot_longer(c(ICU_total, ICU_prev), names_to = "week", values_to = "number") %>%
      group_by(date) %>%
      nest() %>%
      mutate(tab = map(data, ~ weekly_ratios_ci(.x$ICU_total, .x$ICU_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1)


wk_gr_hosp_icu_latest <- filter(wk_gr_hosp_icu, date == max(wk_gr_hosp_icu$date))

wk_gr_hosp_hosp <- data_hosp %>%
       mutate(Hosp_prev = lag(Hospital_confirmed , 7), 
         weekdays(date)) %>%
       filter(date >= ymd("2020-03-25")) %>%
       #pivot_longer(c(Hospital_total, Hosp_prev), names_to = "week", values_to = "number") %>%
      group_by(date) %>%
      nest() %>%
      mutate(tab = map(data, ~ weekly_ratios_ci(.x$Hospital_confirmed, .x$Hosp_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(date, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1)

# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$ratio_under_1)
# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$ratio_under_1)
# 
# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$significance)
# table(filter(wk_gr_hosp_hosp, date >= max(ymd(wk_gr_hosp_hosp$date))-20)$ratio_under_1)

# table(filter(wk_gr_hosp_icu, date >= max(ymd(wk_gr_hosp_icu$date))-20)$significance)
# table(filter(wk_gr_hosp_icu, date >= max(ymd(wk_gr_hosp_icu$date))-20)$ratio_under_1)

wk_gr_hosp_hosp_latest <- filter(wk_gr_hosp_hosp, date == max(wk_gr_hosp_icu$date))

# Import NRS data
myurl_deaths <- "https://www.nrscotland.gov.uk/files//statistics/covid19/covid-deaths-data-week-20.xlsx"
GET(myurl_deaths, write_disk(tmp <- tempfile(fileext = ".xlsx")))
GET(myurl_deaths, write_disk("nrs.xlsx", overwrite = TRUE))

#NRS weekly
nrs_deaths_covid_raw <- read_excel(tmp, sheet = "Table 1 - COVID deaths", skip = 3) %>%
  select(-`Year to Date`) %>%
  rename("Details" = "...2",
         "Total" = "...24")

nrs_deaths_covid <- nrs_deaths_covid_raw %>% filter(`Week beginning` == "Deaths involving COVID-194") %>%
  pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  mutate(Type = "Covid19 deaths") %>%
  select(week_beginning, weekly_deaths_total, Type)

# NRS daily
nrs_deaths_covid_raw_daily <- read_excel(tmp, sheet = "Figure 2 data", skip =2) %>%
  filter(!is.na(Source)) %>%
  mutate(date = janitor::excel_numeric_to_date(parse_number(Date1))) %>%
  filter(Source == "NRS") %>%
  mutate(new_deaths = c(0,diff(`Cumulative Count`, 1))) 

#Holidays to adjust
# Monday/Tuesday death numbers that can be adjusted are: 13/14 April, 4/5 May, 18/19 May (Victoria day), and for the future 25/26 May (Whitsun). We may also see an effect for 8/9 June (Queen’s official birthday)
#The will affect ratios for 13/20/27 April, 4/11/18/25 May and 1/8 June. 

bank_hol <- dmy(c("13/4/2020", "14/4/2020","04/05/2020", "05/05/2020", "18/05/2020", "19/05/2020", "25/05/2020", "26/05/2020"))

# NRS daily adjust bank holiday effect
nrs_deaths_covid_raw_daily <- nrs_deaths_covid_raw_daily %>%
  mutate(dow = weekdays(date)) %>%
  mutate(bank_hol = if_else(date %in% bank_hol, "Yes", "No"))

nrs_deaths_covid_raw_daily_montues <- nrs_deaths_covid_raw_daily %>%
  filter(dow %in% c("Monday", "Tuesday"))

nrs_non_hol_perc <- nrs_deaths_covid_raw_daily_montues %>% 
  filter(bank_hol == "No") %>%
  group_by(dow) %>%
  summarise(new_deaths_tot = sum(new_deaths)) %>%
  mutate(perc = new_deaths_tot/sum(new_deaths_tot))
  
nrs_deaths_covid_raw_daily_adj <- nrs_deaths_covid_raw_daily_montues %>% 
  filter(bank_hol == "Yes") %>%
  mutate(week_no = week(date)) %>%
  group_by(week_no) %>%
  mutate(new_deaths_tot = sum(new_deaths)) %>%
  mutate(new_deaths_adj = case_when(dow == "Monday" ~ new_deaths_tot*nrs_non_hol_perc$perc[1], 
                                   dow == "Tuesday" ~ new_deaths_tot*nrs_non_hol_perc$perc[2])) %>%
  ungroup() %>%
  select(date, new_deaths_adj)

nrs_deaths_covid_raw_daily <- left_join(nrs_deaths_covid_raw_daily, nrs_deaths_covid_raw_daily_adj, by = "date") %>%
  mutate(new_deaths_adj = coalesce(new_deaths_adj,new_deaths)) 



# Import Scottish covid data
#path <- "COVID-19_Scotland_data_all_2020-04-10.xlsx" 
path <- paste0("Daily_Reports/COVID-19_Scotland_data_all_", {Sys.Date()-1}, ".xlsx") 
# Scottish cases data
scot_data_raw <- read_excel(path, sheet = "Cases By Health Board", skip = 1)
scot_data_raw <- filter(scot_data_raw, !Health_Board %in% c("Increase", "pIncrease")) %>%
              rename(confirmed_cases= Total,
                     Date = Health_Board) %>%
              mutate(date = lubridate::ymd(Date)) %>%
              select(-Date) 
  
scot_data_raw$date[nrow(scot_data_raw)] <- scot_data_raw$date[nrow(scot_data_raw)-1] + days(1)
#scot_data_raw$confirmed_cases[nrow(scot_data_raw)] <- 4565 ## REMOVE

scot_data_raw <- scot_data_raw %>%
              mutate(date = date - days(1))

scot_data <- scot_data_raw %>%
             mutate(new_cases = confirmed_cases - replace_na(lag(confirmed_cases),0)) #%>%
             #mutate(doubling_time_week = 7*log(2)/log(confirmed_cases/replace_na(lag(confirmed_cases,7),0))) 

# HPS cases adjust bank holiday effect
scot_data <- scot_data %>%
  mutate(dow = weekdays(date)) %>%
  mutate(bank_hol = if_else(date %in% bank_hol, "Yes", "No"))

scot_data_montues <- scot_data %>%
  filter(dow %in% c("Monday", "Tuesday"))

cases_non_hol_perc <- scot_data_montues %>% 
  filter(bank_hol == "No") %>%
  group_by(dow) %>%
  summarise(new_cases_tot = sum(new_cases)) %>%
  mutate(perc = new_cases_tot/sum(new_cases_tot))
  
scot_data_adj <- scot_data_montues %>% 
  filter(bank_hol == "Yes") %>%
  mutate(week_no = week(date)) %>%
  group_by(week_no) %>%
  mutate(new_cases_tot = sum(new_cases)) %>%
  mutate(new_cases_adj = case_when(dow == "Monday" ~ new_cases_tot*cases_non_hol_perc$perc[1], 
                                   dow == "Tuesday" ~ new_cases_tot*cases_non_hol_perc$perc[2])) %>%
  ungroup() %>%
  select(date, new_cases_adj)

scot_data <- left_join(scot_data, scot_data_adj, by = "date") %>%
  mutate(new_cases_adj = coalesce(new_cases_adj,new_cases)) 

             
# Scottish death data
scot_deaths <- read_excel(path, sheet = "Scotland Deaths", skip = 1) %>%
  rename("deaths" = Deaths_Cum, 
         "new_deaths" = Deaths_New) %>%
  #mutate(doubling_time_week = 7*log(2)/log(deaths/replace_na(lag(deaths,7),0))) %>%
  mutate(date = lubridate::ymd(Date))
  

scot_deaths$date[nrow(scot_deaths)] <- scot_deaths$date[nrow(scot_deaths)-1] + days(1)

scot_deaths <- scot_deaths %>%
  mutate(date = date - days(1)) %>%
  select(-Date)

# HPS deaths adjust bank holiday effect
scot_deaths <- scot_deaths %>%
  mutate(dow = weekdays(date)) %>%
  mutate(bank_hol = if_else(date %in% bank_hol, "Yes", "No"))

scot_deaths_montues <- scot_deaths %>%
  filter(dow %in% c("Monday", "Tuesday"))

non_hol_perc <- scot_deaths_montues %>% 
  filter(bank_hol == "No") %>%
  group_by(dow) %>%
  summarise(new_deaths_tot = sum(new_deaths)) %>%
  mutate(perc = new_deaths_tot/sum(new_deaths_tot))

non_hol_perc_deaths_hps <- non_hol_perc
  
scot_deaths_adj <- scot_deaths_montues %>% 
  filter(bank_hol == "Yes") %>%
  mutate(week_no = week(date)) %>%
  group_by(week_no) %>%
  mutate(new_deaths_tot = sum(new_deaths)) %>%
  mutate(new_deaths_adj = case_when(dow == "Monday" ~ new_deaths_tot*non_hol_perc$perc[1], 
                                   dow == "Tuesday" ~ new_deaths_tot*non_hol_perc$perc[2])) %>%
  ungroup() %>%
  select(date, new_deaths_adj)

scot_deaths <- left_join(scot_deaths, scot_deaths_adj, by = "date") %>%
  mutate(new_deaths_adj = coalesce(new_deaths_adj,new_deaths)) 

# Scottish tests
scot_tests <- read_excel(path, sheet = "CPT & DPC") 
#scot_tests$Cases[nrow(scot_tests)] <- 4565 #REMOVE

scot_tests  <- scot_tests %>%
  rename("Conducted" = Tests, 
         "Total Positive" = Cases,
         "deaths_per_case" = DPC,
         "cases_per_test" = CPT) %>%
  mutate("Conducted today" = Conducted - replace_na(lag(Conducted), 0)) %>%
  mutate("Total Negative" = Conducted - `Total Positive`) %>%
  mutate("Positive" = `Total Positive` - replace_na(lag(`Total Positive`), 0),
         "Negative" = `Total Negative` - replace_na(lag(`Total Negative`), 0)) 
scot_tests$Positive[scot_tests$Date == ymd("2020-03-12")] <- 24
scot_tests$Negative[scot_tests$Date == ymd("2020-03-12")] <- 552

  
scot_tests_long <- scot_tests %>%
pivot_longer(cols = Positive:Negative, names_to = "Result", values_to = "Number") %>%
mutate(Result = factor(Result, levels = c("Positive", "Negative")))


# Plot colours
#nice_blue <- palette_OkabeIto[5]
#nice_red <- palette_OkabeIto[6]  

nice_blue <- "#0072B2"
nice_red <- "#D55E00"
nice_green <- "#009E73"
nice_orange <- "#E69F00"

#The will affect ratios for 13/20/27 April, 4/11/18/25 May and 1/8 June. 
#public_hols_keep <- unique(c(c(bank_hol+days(6),
#                    bank_hol+days(7)), dmy(c("12/4/2020","13/4/2020","14/4/2020","26/4/2020", #"27/4/2020","28/4/2020", "3/5/2020","4/5/2020","5/5/2020","17/5/2020", "18/5/2020", #"19/5/2020"))))
public_hols_keep_ci <- dmy(c("13/4/2020", "20/4/2020", "27/4/2020","4/5/2020", "11/05/2020", "18/5/2020", "25/5/2020", "1/6/2020", "8/6/2020"))
public_hols_keep <- c(public_hols_keep_ci, public_hols_keep_ci+days(1), public_hols_keep_ci-days(1)) %>% sort()
public_hols_keep_line <- c(public_hols_keep_ci, public_hols_keep_ci-days(1)) %>% sort()

# Weekly Growth 
wk_gr_newcases <- scot_data %>% select(new_cases, date) %>%
      mutate(outcome = new_cases) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "raw")

wk_gr_newcases_adj <- scot_data %>% select(new_cases_adj, date) %>%
      mutate(outcome = new_cases_adj) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "adjusted") %>%
       mutate(ratio_m = case_when(date %in% public_hols_keep ~ ratio_m),
              lci = case_when(date %in% public_hols_keep_ci ~ lci),
              uci = case_when(date %in% public_hols_keep_ci ~ uci)) 


wk_gr_newcases_adj <- bind_rows(wk_gr_newcases, wk_gr_newcases_adj) %>% mutate(source = "HPS")

#table(filter(wk_gr_newcases, date >= max(ymd(wk_gr_newcases$date))-20)$significance)
#table(filter(wk_gr_newcases, date >= max(ymd(wk_gr_newcases$date))-20)$ratio_under_1)

wk_gr_newdeaths <- scot_deaths %>% select(new_deaths, date) %>%
      mutate(outcome = new_deaths) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "raw")

wk_gr_newdeaths_adj <- scot_deaths %>% select(new_deaths_adj, date) %>%
      mutate(outcome = new_deaths_adj) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
  mutate(ratio_under_1 = ratio_m<1) %>%
       mutate(type = "adjusted") %>%
       mutate(ratio_m = case_when(date %in% public_hols_keep ~ ratio_m),
              lci = case_when(date %in% public_hols_keep_ci ~ lci),
              uci = case_when(date %in% public_hols_keep_ci ~ uci))

wk_gr_newdeaths_adj_mainplot <- scot_deaths %>% select(new_deaths_adj, date) %>%
      mutate(outcome = new_deaths_adj) %>%
       weekly_ratios() %>%
      mutate(ci = case_when(date %in% public_hols_keep_ci ~ "Adjusted",
                            !date %in% public_hols_keep_ci ~ "Unadjusted"),
             line =case_when(date %in% public_hols_keep_line ~ "Adjusted",
                            !date %in% public_hols_keep_line ~ "Unadjusted") )

wk_gr_newdeaths_adj_adj <- wk_gr_newdeaths_adj %>%
               mutate(adjusted = date %in% public_hols_keep_ci,
                      adjusted_line = date %in% public_hols_keep)

wk_gr_newdeaths_adj <- bind_rows(wk_gr_newdeaths, wk_gr_newdeaths_adj) %>% mutate(source = "HPS")

#table(filter(wk_gr_newdeaths, date >= max(ymd(wk_gr_newdeaths$date))-20)$significance)
#table(filter(wk_gr_newdeaths, date >= max(ymd(wk_gr_newdeaths$date))-20)$ratio_under_1)


wk_gr_newdeaths_nrs <- nrs_deaths_covid_raw_daily %>% select(new_deaths, date) %>%
      mutate(outcome = new_deaths) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(type = "raw")

wk_gr_newdeaths_nrs_adj <- nrs_deaths_covid_raw_daily %>% select(new_deaths_adj, date) %>%
      mutate(outcome = new_deaths_adj) %>%
       weekly_ratios() %>%
       filter(!is.na(ratio) & !is.infinite(ratio)) %>%
       significance_wk() %>%
       mutate(type = "adjusted") %>%
       mutate(ratio_m = case_when(date %in% public_hols_keep ~ ratio_m),
              lci = case_when(date %in% public_hols_keep_ci ~ lci),
              uci = case_when(date %in% public_hols_keep_ci ~ uci))

wk_gr_newdeaths__nrs_adj_adj <- wk_gr_newdeaths_nrs_adj %>%
               mutate(adjusted = date %in% public_hols_keep_ci)

wk_gr_newdeaths_nrs_adj<- bind_rows(wk_gr_newdeaths_nrs, wk_gr_newdeaths_nrs_adj) %>% mutate(source = "NRS")

wk_gr_newdeaths_nrs_hps <- bind_rows(wk_gr_newdeaths %>% mutate(source = "HPS"),
wk_gr_newdeaths_nrs %>% mutate(source = "NRS"))

wk_gr_newdeaths_nrs_hps_adj <- bind_rows(wk_gr_newdeaths_adj,
wk_gr_newdeaths_nrs_adj)

#nrs by age
nrs_deaths_covid_week_age <- nrs_deaths_covid_raw %>% 
                             slice(9:15) %>%
                             pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  #mutate(Details = case_when(`Week beginning` == "Deaths involving COVID-194" ~ "All",
  #                           TRUE ~ Details)) %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  select(-`Week beginning`) %>%
  rename("Age Group" = Details) %>%
  #filter(Location != "Other institution") %>%
  select(`Age Group`, week_beginning, weekly_deaths_total) %>%
  mutate(week_ending = week_beginning + 6)

wk_gr_nrs_deaths_age <- nrs_deaths_covid_week_age %>%
  group_by(`Age Group`) %>%
  mutate(week_ending_prev = lag(weekly_deaths_total, 1)) %>%
  filter(!is.na(week_ending_prev) & week_ending_prev >0) %>% 
  ungroup() %>%
  group_by(`Age Group`, week_ending) %>%
  nest() %>%
  mutate(tab = map(data, ~ weekly_ratios_ci(.x$weekly_deaths_total, .x$week_ending_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(`Age Group`, week_ending, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  rename(date = week_ending)


#nrs by location
nrs_deaths_covid_week <- nrs_deaths_covid_raw %>% 
  filter(`Week beginning` == "Deaths involving COVID-194" | 
          Details %in% c("Care Home", "Home / Non-institution", "Hospital", "Other institution")) %>%
  pivot_longer(cols = `43829`:names(nrs_deaths_covid_raw)[ncol(nrs_deaths_covid_raw)-1],
               names_to = "week_beginning", 
               values_to = "weekly_deaths_total") %>%
  mutate(Details = case_when(`Week beginning` == "Deaths involving COVID-194" ~ "All",
                             TRUE ~ Details)) %>%
  mutate(week_beginning = janitor::excel_numeric_to_date(parse_number(week_beginning))) %>%
  mutate(Type = "Covid19 deaths") %>%
  rename("Location" = Details) %>%
  filter(Location != "Other institution") %>%
  select(Location, week_beginning, weekly_deaths_total, Type) %>%
  mutate(week_ending = week_beginning + 6)

wk_gr_nrs_deaths <- nrs_deaths_covid_week %>%
  group_by(Location) %>%
  mutate(week_ending_prev = lag(weekly_deaths_total, 1)) %>%
  filter(!is.na(week_ending_prev) & week_ending_prev >0) %>% 
  #pivot_longer(c(weekly_deaths_total,week_ending_prev), names_to = "week", values_to = "new_numbers_week") %>%
  #mutate(week = factor(week, levels = c("week_ending_prev", "weekly_deaths_total"))) %>%
  ungroup() %>%
  group_by(Location, week_ending) %>%
  nest() %>%
  mutate(tab = map(data, ~ weekly_ratios_ci(.x$weekly_deaths_total, .x$week_ending_prev))) %>%
  mutate(ratio_m = map_dbl(tab, ~parse_number(as.character((.x[1,2]))))) %>% 
  mutate(lci = map_dbl(tab, ~parse_number(as.character((.x[2,2]))))) %>% 
  mutate(uci = map_dbl(tab, ~parse_number(as.character((.x[3,2]))))) %>% 
  ungroup() %>%
  select(Location, week_ending, ratio_m, lci, uci) %>%
  mutate(comparison = if_else(ratio_m >1, "greater than", "less than")) %>%
  significance_wk() %>%
  rename(date = week_ending)

wk_gr_nrs_deaths <- left_join(wk_gr_nrs_deaths,
  nrs_deaths_covid_week %>% 
  filter(weekly_deaths_total >0) %>%
  rename("change" = weekly_deaths_total, 
         "date" = "week_ending") %>%
  select(change, date, Location))

wk_gr_newdeaths_latest <- wk_gr_newdeaths %>% mutate(source = "HPS", Location = "HPS") %>% filter(date == max(wk_gr_newdeaths$date))

wk_gr_nps_nrs <- bind_rows(wk_gr_newdeaths %>% mutate(source = "HPS")  %>%
                           filter(date %in% wk_gr_nrs_deaths$date), 
                           wk_gr_nrs_deaths %>% mutate(source = "NRS"))
wk_gr_nps_nrs <- wk_gr_nps_nrs %>%
                 mutate(Location = case_when( source == "HPS" ~ source, 
                                              Location == "All" ~ "NRS",
                                             TRUE ~ Location))
  
```

Numbers of new cases and new deaths, as reported by Health Protection Scotland (HPS), have been monitored on a daily basis (Figure \@ref(fig:dailydeathscases)). To assess the rate of spread of COVID-19 in Scotland, we have considered the ratio of the sum of these metrics in the past week compared to their respective sums in the previous week. A similar ratio has been used to measure changes in the number of patients in hospital by comparing daily numbers of patients in hospital and ICU to those one week ago (Figure \@ref(fig:dailyoccupancy)). However, these statistics are potentially subject to biases and we list several caveats which should be considered when interpreting their values.


\subsection*{Data}

We use publically available data on the daily numbers of cases, deaths, and the numbers of patients in hospital and in ICU units to form our indicators. The cumulative number of cases and deaths has been reported each day since the start of the pandemic in Scotland by Health Protection Scotland (HPS). The deaths include those which have been registered with the National Records of Scotland (NRS) where a laboratory confirmed report of COVID-19 in the 28 days prior to death exists. Thus these numbers are expected to capture the majority of deaths occurring in hospitals, but a lower proportion of those in care homes and the community. The NRS additionally provide a weekly report of all deaths where COVID-19 is mentioned on the death certificate (not just those confirmed by a test as provided by HPS). 

The number of COVID-19 patients in hospital and intensive care units (ICUs) is reported by NHS boards on a daily basis. This report includes all patients with COVID-19 who are registered as being in hospital (or ICU) at midnight each day (Figure \@ref(fig:dailyoccupancy)). Both confirmed and suspected patients are included in the ICU numbers, but only confirmed patients are included for the total hospital in-patients. Reports issued before 25th May included both suspected and confirmed cases in the hospital in-patient total, but suspected cases have now been excluded as they were subject to unexplained fluctuations.

\subsection*{Weekly comparisons}
We have used ratios of both cases and deaths in the past week compared to the previous week (i.e. the total over the 7 days as a ratio of the total over the previous 7 days) to monitor the weekly rate of spread of COVID-19 (Figures \@ref(fig:deathscaseshospicu), \@ref(fig:ratiosnrshpsloc), \@ref(fig:ratiosnrshpsdaily) and Table \@ref(tab:tabdeathscaseshospicu)). Weekly totals are considered as they are less prone to week day variations than the daily values (see Caveats below).

Ratios for patients in hospital are calculated as the number of patients in hospital (or ICU) on a given day compared to the number of patients in hospital (or ICU) one week before (e.g. the ratio for `r gsub(", [0-9]+", "", toOrdinalDate(Sys.Date()))` is ‘number of patients on `r gsub(", [0-9]+", "", toOrdinalDate(Sys.Date()))`’ divided by ‘number of patients on `r gsub(", [0-9]+", "", toOrdinalDate(Sys.Date()-7))`’).

Further detail on the sources of data and code used to produce this report, and the method used to calculate confidence intervals for ratios, is available on GitHub at [gcalder/COVID-19](https://github.com/gcalder/COVID-19).

<!--The confidence interval for the log of the ratio of two frequencies (w1/w2) may be approximated by {1/w1 + 1/w2}, based on assuming a Poisson distribution for w1 and w2 (w1 = total cases (or deaths) in past week and w2 = total cases (or death) in previous week, or for number of patients in hospital w1=number of patients on the given day, w2=number of patients on that day the week before). The approximation is obtained from the standard formula: 
\hfill \break


\begin{tabular}{rrll}\
& $Var\{log(a)\}$ & $\approx$ & $Var(a)/Mean(a)^2$\\
&  & = & $a/a^2$ for a Poisson frequency \\
& & = & $1/a$ \\
& & & \\
\multicolumn{2}{c}{The ratio on a log scale may be expressed:} & &\\
& & & \\
& $log(w1/w2)$ & = & $log(w1)$ – $log(w2)$ \\
& & & \\
 \multicolumn{2}{r}{giving} & &\\
& & & \\
& $Var\{log(w1/w2)\} $ & = & $Var\{log(w1)$ - $log(w2)\}$\\
& & = & $Var\{log(w1)\}$ + $Var\{log(w2)\}$  \\
&  & = &  $\{1/w1 + 1/w2\}$ \\
& & & \\
 \multicolumn{2}{r}{and} & &\\
&  & & \\
& $SE\{log(w1/w2)\}$ & = & $\sqrt\{1/w1$ + $1/w2\}$ \\
\end{tabular}


\hfill \break
The 95% confidence interval is then calculated as log(w1/w2) ± 1.96 x SE, which is exponentiated to provide the confidence intervals displayed.-->

\subsection*{Caveats and Interpretational Notes}

We list several caveats which should be borne in mind when considering the statistics presented.

Daily numbers of cases and deaths are affected by:

-	Changes in testing policy which in turn is affected by the availability of tests and laboratory facilities for their analysis. For example, if testing is increased then less severe cases of COVID-19 are likely to be detected.

-	Variations in hospital admission policy, e.g. if admission criteria are relaxed then a higher proportion of COVID-19 patients are admitted and tested, and then included in the daily case and (HPS) death statistics.

- Variations in reporting of deaths and test results across week days (Figure \@ref(fig:dayoftheweeklast2weeks)) and due to public holidays.

<!--HPS death counts include individuals who are tested outside hospital. An increased frequency of testing in care homes coupled with the increasing number of deaths in this setting (see Figures \@ref(fig:deathsno) and \@ref(fig:ratiosnrshpsloc)) makes HPS numbers difficult to compare over time. The NRS ‘all COVID-19’ death numbers may allow a more consistent comparison to be made, and additionally allow care home and other non-hospital deaths to be considered separately. However, these data are only issued on a weekly basis and they will be less up-to-date than that from HPS.-->

An increase in testing is likely to cause an increased number of less severe cases to be included and this may make comparisons of case numbers over time unreliable. Nevertheless, a decrease in cases would still provide strong evidence of a reducing rate of infection.

```{r}
latest_nrs_hps <- wk_gr_nps_nrs %>% 
#filter(Location %in% c("NRS", "HPS")) %>%
mutate(Location2 = recode_factor(Location, "HPS" = "HPS", 
                                            "NRS" = "NRS",
                                            "Care Home" = "CH", 
                                            "Hospital" = "Hosp", 
                                            "Home / Non-institution" = "HN"))%>%
filter(date == max(wk_gr_nps_nrs$date)) %>%
  mutate(ratio_m = formatC(ratio_m, format='f', digits=2, zero.print = TRUE), 
         lci = formatC(lci, format='f', digits=2, zero.print = TRUE), 
         uci = formatC(uci, format='f', digits=2, zero.print = TRUE))

latest_nrs_hps_date <- format(max(wk_gr_nps_nrs$date), '%d/%m/%Y')
```

Death numbers reported by HPS include individuals who have positive tests but are not in hospital. Increased testing in the community (particularly in care homes) will cause more deaths to be counted and make HPS death numbers difficult to compare over time. The NRS death numbers are expected to provide a more consistent comparison, and also to allow care home and other non-hospital deaths to be considered separately. However, these data are only issued on a weekly basis and they will be less up-to-date than the data from HPS. The latest weekly ratio for NRS deaths, `r filter(latest_nrs_hps, Location == "NRS")$ratio_m` (95% CI `r filter(latest_nrs_hps, Location == "NRS")$lci`-`r filter(latest_nrs_hps, Location == "NRS")$uci`), is lower than the equivalent value for HPS deaths `r filter(latest_nrs_hps, Location == "HPS")$ratio_m` (95% CI `r filter(latest_nrs_hps, Location == "HPS")$lci`-`r filter(latest_nrs_hps, Location == "HPS")$uci`) and might be expected to provide a more accurate reflection of the underlying state of the epidemic (based on NRS data up to `r latest_nrs_hps_date`; Figures \@ref(fig:ratiosnrshpsloc) and \@ref(fig:ratiosnrshpsdaily)).

```{r}
nrs_hosp <- filter(wk_gr_nps_nrs, Location =="Hospital" & date == max(wk_gr_nps_nrs$date))
nrs_carehomes <- filter(wk_gr_nps_nrs, Location =="Care Home" & date == max(wk_gr_nps_nrs$date))
nrs_agegroup_85 <- filter(wk_gr_nrs_deaths_age, `Age Group` == "85+" & date ==max(wk_gr_nrs_deaths_age$date))
```

Given the later availability of NRS data and the variable factors affecting both the number of cases and HPS deaths, some consideration might be given to hospital data (Figures \@ref(fig:dailyoccupancy) and \@ref(fig:deathscaseshospicu)). However, these data will not reflect deaths occurring in care homes. They will also be affected by any change in the guidance for admission and discharge during the two week period considered for the ratio. Recent changes to the guidance for care home residents may be causing a greater proportion of these cases to be admitted to hospital and for longer stays. The ratios by place of death (Figure \@ref(fig:ratiosnrshpsloc)) will also be subject to any variation in hospital admission policy. For example, if the proportion of care home residents being admitted to hospital has changed over a two week period, this would affect the ratios for deaths in care homes and in hospitals. <!--Consideration of the weekly deaths ratio for the oldest age group may provide some additional insight - the latest ratio for deaths is `r round(nrs_agegroup_85$ratio_m,2)` (95% CI: `r round(nrs_agegroup_85$lci,2)`-`r round(nrs_agegroup_85$uci,2)`) for people aged 85 or more, suggesting the rate of death in this group is currently reducing.-->

The use of weekly ratios helps to smooth out variations occurring across week days, however they will still be affected by public holidays. For example, a lower number of deaths were registered on 4th May (Spring bank holiday), followed by a higher number on Tuesday 5th May. This caused the ratio for Monday 4th May to be artificially low, the ratio the following Monday (11th May) to be artificially high, and the ratio on the Monday two weeks later (18th May) to be artificially low. This was due to the separation of the (low and high) numbers for Monday 4th and Tuesday 5th May in the weeks used to calculate ratios for these Mondays. A similar pattern was noticed for 13th/14th April (Easter Monday) and 18th/19th May (Victoria Day), which would be expected to affect ratios on the holiday dates and the two subsequent Mondays in the same way. In Figures \@ref(fig:deathscaseshospicu) and \@ref(fig:ratiosnrshpsdaily) the affected ratios have been adjusted for this ‘holiday effect’ and are shown in grey. The adjustment is carried out by apportioning the number of deaths reported on Mondays and Tuesdays of ‘holiday’ weeks to match the distribution of those observed on ‘non-holiday’ Mondays and Tuesdays. For example, `r subset(scot_deaths, date == "2020-05-04")$new_deaths` and `r subset(scot_deaths, date == "2020-05-05")$new_deaths` deaths were reported by HPS for Monday 4th and Tuesday 5th May and these `r subset(scot_deaths, date == "2020-05-04")$new_deaths+subset(scot_deaths, date == "2020-05-05")$new_deaths` deaths were redistributed to be `r round(subset(scot_deaths, date == "2020-05-04")$new_deaths_adj)` and `r round(subset(scot_deaths, date == "2020-05-05")$new_deaths_adj)`, so that they followed the average proportions observed for ‘non-holiday’ Mondays and Tuesdays (`r round(100*non_hol_perc_deaths_hps$perc[1],1)`% and `r round(100*non_hol_perc_deaths_hps$perc[2],1)`%). Figure 6 additionally shows the unadjusted ratios for comparison.

The confidence intervals indicate the accuracy of the observed ratio of the two particular weeks considered. However, there are many factors which influence the ratios other than the true underlying rate of spread of COVID-19. Some of these will be systematic (as described in the above caveats) and others may be more random. The caveats should all be considered when interpreting the ratios, particularly when the confidence interval does not include 1. 

There is some analogy between the ratios presented and the R number, and values of less than 1 (or greater than 1) might be expected to correspond to R numbers of less than (or greater than) 1. However, their values will not be identical and this analogy is based on unchanged policies for testing and hospitalisation over the two week period used to calculate each ratio. Furthermore it should be borne in mind that each statistic reflects a different manifestation of the virus, and none will be fully representative of the true underlying rate of spread of infection in the full population. Death ratios are heavily influenced by the rate of spread to and within older age groups, and take less account of the rate of spread in younger age groups. Similarly cases and hospital in-patients predominantly include those with more severe symptoms, and so do not fully capture the rate of infection spread within the whole population. Nevertheless these statistics have clear value for monitoring the impact of the virus on health service requirements, and will still serve as broad indicators of the underlying rate of spread of the virus. An ongoing survey of the population would be needed to provide more definitive estimates of this rate.

<!--A modelling approach would be suggested to confirm whether the ratios have consistently fallen below 1 and to determine whether their values have stabilised. Note that while the ratios are related to the R number and values of less than (or greater than) 1 might be expected to correspond to R numbers of less than (or greater than) 1, their values will not be the same. Additionally this analogy is based on unchanged policies for testing and hospitalisation over the two week period used to calculate the ratio.-->




```{r traj, fig.width=6, fig.height=5, fig.cap="Trajectories of COVID-19 cases and deaths vs respective cumulative numbers. Data source: HPS", eval = FALSE }
cases_deaths <- bind_rows(select(scot_data, date, new_cases, confirmed_cases) %>% 
            rename("new" = new_cases, "cumulative" = confirmed_cases) %>%
              mutate(type = "cases") %>%
              mutate(change = roll_sumr(new, n = 7)) ,
         select(scot_deaths, date, new_deaths, deaths) %>% 
           filter(deaths >0) %>%
            rename("new" = new_deaths, "cumulative" = deaths) %>%
              mutate(type = "deaths") %>%
              mutate(change = roll_sumr(new, n = 7)))

arrow_date <- max(cases_deaths$date)-25
#arrow_date <- ymd("2020-03-23")
cases_deaths_date <- subset(cases_deaths, date == arrow_date) %>%
                     mutate(y = change + c(50, 20),
                            yend = change + c(500, 100), 
                            yend_date = yend + c(122, 40))


ggplot(cases_deaths) +
    aes(x = cumulative, y = change, group = type, colour = type) +
    geom_line(lwd = 1) +
    geom_point(size = 0.7) +
    scale_x_continuous(trans = "log10",
                       labels = scales::comma_format(accuracy = 1),
                       #breaks = breaks,
                       expand = expansion(mult = 0.01), 
                       limits = c(10, NA)) +
    scale_y_continuous(trans = "log10",
                       labels = scales::comma_format(accuracy = 1),
                       limits = c(min(filter(cases_deaths, cumulative >=10)$change, na.rm = TRUE), max(cases_deaths$change, na.rm = TRUE)+500),
                       #expand = expansion(mult = 0.05)
                       ) +
    geom_segment(data = cases_deaths_date, colour = "black", aes(x = cumulative, y = y, xend = cumulative, yend = yend),
               arrow = arrow(length = unit(2, "mm"), ends = "first")) +
    geom_text(data = cases_deaths_date, colour = "black", aes(x = cumulative, y = yend_date, label = date)) +
    guides(x = guide_axis(check.overlap = TRUE), y = guide_axis(check.overlap = TRUE)) +
    theme(legend.position = "none") +
    labs(y = str_glue("New cases/deaths \n(in the past 7 days)"),
         x = str_glue("Total Number"),
         title = str_glue("Trajectory of COVID-19 cases/deaths vs current total"), 
         #subtitle = str_glue("Arrows = ", {as.character(arrow_date)}),
         subtitle = str_glue("Starting date: ", {as.character(min(filter(cases_deaths, cumulative >=10)$date))}),
         colour = "") +
  theme_bw(base_size = 12) +
  theme(legend.position = c(0.20, 0.85))
```

\hfill \break

```{r dailydeathscases, fig.width=8, fig.height=5.4, fig.cap = "Daily cases and deaths and 7 day rolling sum"}

ymax <- 8
fig1 <- scot_data %>%
  select(new_cases, date) %>%
  mutate(rolling_sum = roll_sumr(new_cases, n = 7)) %>%
ggplot() + 
  geom_bar(aes(x = date, y = new_cases), stat = "identity", colour = "white", size = 0.2) +
  geom_line(aes(x = date, y = rolling_sum/ymax), colour = "red") +
  scale_y_continuous(name = 'New Cases', sec.axis = sec_axis(~.*ymax, 
                                                                   name = "7 day rolling sum")) +
  scale_x_date(date_breaks = "2 week", labels = date_format("%b %d"),
               limits = c(ymd("2020-02-29"), max(scot_data$date))) +
  labs(x = "Date") +
  theme_bw(base_size = 10)

ymax <- 5
fig2 <- scot_deaths %>%
  select(new_deaths, date) %>%
  mutate(rolling_sum = roll_sumr(new_deaths, n = 7)) %>% 
  filter(new_deaths >0) %>%
ggplot() + 
  geom_bar(aes(x = date, y = new_deaths), stat = "identity", colour = "white", size = 0.2) +
  geom_line(aes(x = date, y = rolling_sum/ymax), colour = "red") +
  scale_y_continuous(name = 'New Deaths (Source: HPS)', sec.axis = sec_axis(~.*ymax, 
                                                                   name = "7 day rolling sum")) +
  scale_x_date(date_breaks = "2 week", labels = date_format("%b %d"), 
               limits = c(ymd("2020-03-11"), max(scot_deaths$date))) +
  labs(x = "Date") +
  theme_bw(base_size = 10)

#fig1 + fig2
#gridExtra::grid.arrange(fig1, fig2, nrow = 1) 
ymax <- 5
fig3 <- nrs_deaths_covid_raw_daily %>%
  select(new_deaths, date) %>%
  mutate(rolling_sum = roll_sumr(new_deaths, n = 7)) %>% 
  filter(new_deaths >0) %>%
ggplot() + 
  geom_bar(aes(x = date, y = new_deaths), stat = "identity", colour = "white", size = 0.2) +
  geom_line(aes(x = date, y = rolling_sum/ymax), colour = "red") +
  scale_y_continuous(name = 'New Deaths (Source: NRS)', sec.axis = sec_axis(~.*ymax, 
                                                                   name = "7 day rolling sum")) +
  scale_x_date(date_breaks = "2 week", labels = date_format("%b %d"), 
               limits = c(ymd("2020-03-11"), max(scot_deaths$date))) +
  labs(x = "Date") +
  theme_bw(base_size = 10)
fig1 + fig2 + plot_spacer() + fig3
```


```{r dailyoccupancy, fig.width=6, fig.height=2.2, fig.cap="Number of patients in hospital and ICU at midnight. Daily totals include both confirmed and suspected COVID-19 cases for ICU, but only confirmed cases for the total hospital in-patients"}
fig6 <- data_hosp %>%
  ggplot() + 
  geom_bar(aes(x = date, y = Hospital_confirmed), stat = "identity", colour = "white", size = 0.2) +
  scale_x_date(date_breaks = "3 week", labels = date_format("%b %d"), 
               limits = c(ymd("2020-03-11"), max(data_hosp$date))) +
  #scale_fill_manual(values = viridis(3, option = "D")[c(2,3,1)]) + 
  theme_bw(base_size = 10) +
  labs(x = "Date", y = "Patients in Hospital") +
  theme(legend.position = c(0.17, 0.8), 
        legend.title = element_blank()) +
  theme(plot.margin = unit(c(0,20,0,0), "pt"))

fig7 <- data_hosp %>%
  ggplot() + 
  geom_bar(aes(x = date, y = ICU_total), stat = "identity", colour = "white", size = 0.2) +
  scale_x_date(date_breaks = "3 week", labels = date_format("%b %d"), 
               limits = c(ymd("2020-03-11"), max(data_hosp$date))) +
  theme_bw(base_size = 10) +
  labs(x = "Date", y = "Patients in ICU") +
  theme(legend.position = c(0.17, 0.8), 
        legend.title = element_blank()) +
  theme(plot.margin = unit(c(0,5,0,20), "pt"))


fig6 + fig7
#gridExtra::grid.arrange(fig2, fig1, nrow = 1) 
```


```{r deathscaseshospicuold, fig.width=5.5, fig.height= 9, fig.cap="Weekly ratios for new cases and new deaths are ratios of weekly sums, plotted on a log10 scale. Day-of-the-week ratios for patients in hospital and ICU are ratios of daily counts, measured 7 days apart and plotted on a log10 scale. Figure insets highlight ratios and trends for the last 21 days.", eval = FALSE}

fig1 <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  scale_y_continuous(trans = "log10",
expand = expansion(mult = 0.1)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        #title = "Change in weekly cases/deaths total as ratio of previous week",
        subtitle = "New Cases (Source: HPS)") +
  theme_bw(base_size = 10) +
  theme(plot.margin = unit(c(0.2,0.5,0.2,0.3), "cm"))

fig1_inset <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newcases$date)-20)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "8 days", labels = date_format("%b %d"),expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "", y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig1 <- ggdraw() +
  draw_plot(fig1) +
  draw_plot(fig1_inset, x = 0.57, y = .54, width = .37, height = .3)

fig2 <- ggplot(wk_gr_newdeaths %>% filter(!is.na(ratio) & 
              !is.infinite(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_red, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_red) +
  geom_point(colour = nice_red, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        subtitle = "New Deaths (Source: HPS)") +
  theme_bw(base_size = 10) + 
  theme(plot.margin = unit(c(0.2,0.5,0.2,0.2), "cm"))

fig2_inset <- ggplot(wk_gr_newdeaths %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newdeaths$date)-20)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_red, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_red) +
  geom_point(colour = nice_red, size = 1) +
  scale_x_date(date_breaks = "8 days", labels = date_format("%b %d"),expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig2 <- ggdraw() +
  draw_plot(fig2) +
  draw_plot(fig2_inset, x = 0.57, y = .54, width = .37, height = .3)


fig3 <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_y_continuous(trans = "log10",
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "Patients in ICU (Source: NHS Boards)") +
  theme_bw(base_size = 10)  + 
  theme(plot.margin = unit(c(0.2,0.4,0.2,0.3), "cm"))



fig3_inset <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_icu$date)-20)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_x_date(date_breaks = "8 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig3 <- ggdraw() +
  draw_plot(fig3) +
  draw_plot(fig3_inset, x = 0.57, y = .54, width = .37, height = .3)

fig4 <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.1) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_y_continuous(trans = "log10",
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "Patients in Hospital (Source: NHS Boards)") +
  theme_bw(base_size = 10)  + 
  theme(plot.margin = unit(c(0.2,0.4,0.2,0.3), "cm"))

fig4_inset <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_hosp$date)-20)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_x_date(date_breaks = "8 days", labels = date_format("%b %d"), expand = expansion(mult = 0.1)) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig4 <- ggdraw() +
  draw_plot(fig4) +
  draw_plot(fig4_inset, x = 0.57, y = .54, width = .37, height = .3)

gridExtra::grid.arrange(fig1, fig2, fig4, fig3, nrow = 4) 
```


\newpage
\thispagestyle{empty}


```{r deathscaseshospicu, fig.width=5.5, fig.height= 9, fig.cap="Weekly ratios for new cases and new deaths are ratios of weekly sums, plotted on a log10 scale. Day-of-the-week ratios for patients in hospital and ICU are ratios of daily counts, measured 7 days apart and plotted on a log10 scale. Entries in grey are adjusted for public holiday effects, see Caveats. Figure insets highlight ratios and trends for the last 21 days."}

fig1 <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  scale_y_continuous(trans = "log10",
                         breaks = c(0.5, 1,3,6),
                         #labels = c(0.5, 1,3,6),
                         expand = expansion(mult = 0.1), limits = c(NA,7)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        #title = "Change in weekly cases/deaths total as ratio of previous week",
        subtitle = "New Cases (Source: HPS)") +
  theme_bw(base_size = 10) +
  theme(plot.margin = unit(c(0.2,0.5,0.2,0.3), "cm"))

fig1_inset <- ggplot(wk_gr_newcases %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newcases$date)-20)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_blue, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_blue) +
  geom_point(colour = nice_blue, size = 1) +
  scale_x_date(date_breaks = "10 days", labels = date_format("%b %d")) +
  scale_y_continuous(trans = "log10") +
  labs( x = "", y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig1 <- ggdraw() +
  draw_plot(fig1) +
  draw_plot(fig1_inset, x = 0.51, y = .55, width = .44, height = .29)


fig2 <- ggplot(wk_gr_newdeaths_adj_mainplot %>% filter(!is.na(ratio) & 
              !is.infinite(ratio) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, alpha = 0.4, aes(colour = ci)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(aes(colour = line, group = 1)) +
  geom_point(size = 1, aes(colour = ci)) +
  scale_y_continuous(trans = "log10",
                         expand = expansion(mult = 0.1),
                     breaks = c(0.5, 1,3,10,30),
                     #labels = c(0.5, 1,3,10,30)
                     ) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  scale_colour_manual(values = c("grey50", nice_red)) +
  scale_fill_manual(values = c("grey50", nice_red)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        subtitle = "New Deaths (Source: HPS)") +
  theme_bw(base_size = 10) + 
  theme(plot.margin = unit(c(0.2,0.5,0.2,0.2), "cm"), 
        legend.position = "none")

fig2_inset <- ggplot(wk_gr_newdeaths_adj_mainplot %>% filter(!is.na(ratio) & 
              !is.infinite(ratio) & date >= max(wk_gr_newdeaths_adj$date)-20)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, alpha = 0.4, aes(colour = ci)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(aes(colour = line, group = 1)) +
  geom_point(size = 1, aes(colour = ci)) +
  scale_x_date(date_breaks = "10 days", labels = date_format("%b %d")#,expand = expansion(mult = 0.1)
               ) +
  scale_colour_manual(values = c("grey50", nice_red)) +
  scale_fill_manual(values = c("grey50", nice_red)) +
    scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"), 
        legend.position = "none")

# fig2 <- ggplot(wk_gr_newdeaths_adj %>% filter(!is.na(ratio) & 
#               !is.infinite(ratio) & date >= dmy("23-03-2020"))) +
#   aes(x = date, y = ratio_m,
#     ymin = lci, ymax = uci, colour = type, fill = type) +
#   geom_errorbar(width = 0, alpha = 0.4) +
#   geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
#   geom_line() +
#   geom_point(size = 1) +
#   scale_y_continuous(trans = "log10",
#   scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
#                limits = c(dmy("23-03-2020"), NA)) +
#   scale_colour_manual(values = c("grey50", nice_red)) +
#   scale_fill_manual(values = c("grey50", nice_red)) +
#   labs( x = "End Date of Current Week",
#         y = "Weekly Ratio",
#         subtitle = "New Deaths (Source: HPS)") +
#   theme_bw(base_size = 10) + 
#   theme(plot.margin = unit(c(0.2,0.5,0.2,0.2), "cm"), 
#         legend.position = "none")
# 
# fig2_inset <- ggplot(wk_gr_newdeaths_adj %>% filter(!is.na(ratio) & 
#               !is.infinite(ratio) & date >= max(wk_gr_newdeaths_adj$date)-20)) +
#   aes(x = date, y = ratio_m,
#     ymin = lci, ymax = uci, colour = type, fill = type) +
#   geom_errorbar(width = 0, alpha = 0.4, position=position_dodge(width=0.3)) +
#   geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
#   geom_line(position=position_dodge(width=0.3)) +
#   geom_point(size = 1, position=position_dodge(width=0.3)) +
#   scale_x_date(date_breaks = "8 days", labels = date_format("%b %d")#,expand = expansion(mult = 0.1)
#                ) +
#   scale_colour_manual(values = c("grey50", nice_red)) +
#   scale_fill_manual(values = c("grey50", nice_red)) +
#     scale_y_continuous(trans = "log10") +
#   labs( x = "",
#         y = "") +
#   theme_bw(base_size = 8) +
#   theme(plot.margin = margin(0, 0, -1, 0, "cm"), 
#         legend.position = "none")

fig2 <- ggdraw() +
  draw_plot(fig2) +
  draw_plot(fig2_inset, x = 0.51, y = .54, width = .44, height = .3)


fig3 <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.1) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_y_continuous(trans = "log10",
                     breaks = c(0.8, 1,2, 3),
                     #labels = c(0.8, 1,2, 3),
                     expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "Patients in Hospital (Source: NHS Boards)") +
  theme_bw(base_size = 10)  + 
  theme(plot.margin = unit(c(0.2,0.4,0.2,0.3), "cm"))

fig3_inset <- ggplot(wk_gr_hosp_hosp %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_hosp$date)-20)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_green, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_green) +
  geom_point(colour = nice_green, size = 1) +
  scale_x_date(date_breaks = "10 days", labels = date_format("%b %d")) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig3 <- ggdraw() +
  draw_plot(fig3) +
  draw_plot(fig3_inset, x = 0.51, y = .54, width = .44, height = .3)

fig4 <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
              !is.infinite(ratio_m) & date >= dmy("23-03-2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_y_continuous(trans = "log10",
                         breaks = c(0.5, 1, 3, 10),
                         #labels = c(0.5, 1, 3, 10),
                         expand = expansion(mult = 0.1)) +
  scale_x_date(date_breaks = "1 week", labels = date_format("%b %d"),
               limits = c(dmy("23-03-2020"), NA)) +
  labs( x = "Current Date",
        y = "Day-Of-The-Week Ratio",
        subtitle = "Patients in ICU (Source: NHS Boards)") +
  theme_bw(base_size = 10)  + 
  theme(plot.margin = unit(c(0.2,0.4,0.2,0.3), "cm"))



fig4_inset <- ggplot(wk_gr_hosp_icu %>% filter(!is.na(ratio_m) & 
                    !is.infinite(ratio_m) & date >= max(wk_gr_hosp_icu$date)-20)) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci) +
  geom_errorbar(width = 0, colour = nice_orange, alpha = 0.4) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(colour = nice_orange) +
  geom_point(colour = nice_orange, size = 1) +
  scale_x_date(date_breaks = "10 days", labels = date_format("%b %d")) +
  scale_y_continuous(trans = "log10") +
  labs( x = "",
        y = "") +
  theme_bw(base_size = 8) +
  theme(plot.margin = margin(0, 0, -1, 0, "cm"))

fig4 <- ggdraw() +
  draw_plot(fig4) +
  draw_plot(fig4_inset, x = 0.51, y = .54, width = .44, height = .3)


gridExtra::grid.arrange(fig1, fig2, fig3, fig4, nrow = 4) 
```

\newpage

```{r tabdeathscaseshospicu}
bind_rows(wk_gr_newcases %>% filter(date == max(wk_gr_newcases$date)) %>% mutate(Measure = "New Cases (Source: HPS)"),
wk_gr_newdeaths %>% filter(date == max(wk_gr_newdeaths$date)) %>% mutate(Measure = "New Deaths (Source: HPS)"),
wk_gr_hosp_hosp %>% filter(date == max(wk_gr_hosp_hosp$date)) %>% mutate(Measure = "Patients in Hospital (Source: NHS Boards)"),
wk_gr_hosp_icu %>% filter(date == max(wk_gr_hosp_icu$date)) %>% mutate(Measure = "Patients in ICU (Source: NHS Boards)")) %>%
  mutate(Ratio = formatC(round(ratio_m,2), format='f', digits=2),
         lci = formatC(round(lci,2), format='f', digits=2),
         uci = formatC(round(uci,2), format='f', digits=2)) %>%
  mutate("95% CI" = paste0(lci, "-", uci)) %>%
  select(Measure, Ratio, `95% CI`) %>%
knitr::kable(
  booktabs = TRUE, escape = T,
  caption = str_glue("Most recent estimates of ratios and their 95\\% confidence intervals (CI). Weekly ratios for new cases and new deaths are ratios of weekly sums. Day-of-the-week ratios for number of patients in hospital and ICU are ratios of daily counts, measured 7 days apart. Date: ", format(max(wk_gr_newcases$date), '%d/%m/%Y'),"."))
```

\hfill \break
\hfill \break
\hfill \break

```{r deathsno, fig.width=8,fig.cap="Number of deaths per week, compared by location and data source"}
ggplot(bind_rows(wk_gr_nps_nrs, wk_gr_newdeaths_latest) %>%
         mutate(Location = factor(Location, levels = c("HPS", "NRS","Care Home", "Hospital","Home / Non-institution"))) %>%
         mutate(Location2 = recode_factor(Location, "HPS" = "HPS", 
                                            "NRS" = "NRS all COVID-19 deaths",
                                            "Care Home" = "Care Home (CH)", 
                                            "Hospital" = "Hospital", 
                                            "Home / Non-institution" = "Home / Non-institution (HN)")),
  aes(x = date, y = change,
    colour = Location2, fill = Location2)) +
  geom_line(position=position_dodge(width=1)) +
  geom_point(size = 1, position=position_dodge(width=1)) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "Week Ending",
        y = "Weekly Deaths",
        title = "Weekly deaths by location and data source", 
        colour = "Location/Source",
        fill = "Location/Source") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw(base_size = 12)
```

```{r weeklyratiosagegroup, fig.width=8,fig.cap="Ratio of new deaths during current week vs previous week, compared by age group. Data source: NRS", eval=FALSE}
ggplot(wk_gr_nrs_deaths_age) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci, 
    colour = `Age Group`, fill = `Age Group`) +
  geom_errorbar(width = 0, alpha = 0.4, position=position_dodge(width=1)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(position=position_dodge(width=1)) +
  geom_point(size = 1, position=position_dodge(width=1)) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        title = "Weekly ratio of new deaths", 
        colour = "Age group",
        fill = "Age group") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw(base_size = 12)
```

\newpage

```{r ratiosnrshpsloc, fig.width=8,fig.cap="Ratio of new deaths during current week vs previous week, compared by location and data source. Figure inset highlights the last date that both HPS and NRS data are available for."}

fig1 <- 
  bind_rows(wk_gr_nps_nrs, wk_gr_newdeaths_latest) %>%
  filter(Location != "Home / Non-institution") %>%
  mutate(Location = factor(Location, levels = c("HPS", "NRS","Care Home", "Hospital"))) %>%
  mutate(Location2 = recode_factor(Location, "HPS" = "HPS", 
                                            "NRS" = "NRS all COVID-19 deaths",
                                            "Care Home" = "Care Home (CH)", 
                                            "Hospital" = "Hospital"#, 
                                            #"Home / Non-institution" = "Home / Non-institution (HN)"
                                   )) %>%
  ggplot() +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci, 
    colour = Location2, fill = Location2) +
  geom_errorbar(width = 0, alpha = 0.4, position=position_dodge(width=1)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(position=position_dodge(width=1)) +
  geom_point(size = 1, position=position_dodge(width=1)) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "End Date of Current Week",
        y = "Weekly Ratio",
        title = "Weekly ratio of new deaths", 
        colour = "Location/Source",
        fill = "Location/Source") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw(base_size = 12)


fig1_inset <- wk_gr_nps_nrs %>% 
#filter(Location %in% c("NRS", "HPS")) %>%
  filter(Location != "Home / Non-institution") %>%
mutate(Location2 = recode_factor(Location, "HPS" = "HPS", 
                                            "NRS" = "NRS",
                                            "Care Home" = "CH", 
                                            "Hospital" = "Hosp", 
                                            #"Home / Non-institution" = "HN"
                                 ))%>%
filter(date == max(wk_gr_nps_nrs$date)) %>%  
ggplot(aes(x = Location2, y = ratio_m,
           ymin = lci, ymax = uci, 
    colour = Location2, fill = Location2)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_point(size = 1.8) +
  geom_errorbar(width = 0, alpha = 0.6, size = 1.2) + 
  labs( x = "",
        y = "",
        #title = "Change in weekly deaths total as ratio of previous week", 
        subtitle = str_glue("Date: ", {as.character(max(wk_gr_nps_nrs$date))} ), 
        colour = "Location/Source",
        fill = "Location/Source") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw(base_size = 10) +
  theme(legend.position = "none") +
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))

ggdraw() +
  draw_plot(fig1) +
  draw_plot(fig1_inset, x = 0.4, y = .48, width = .23, height = .35)
```



```{r ratiosnrshpsdailyold, fig.width=8, fig.cap="Ratio of new deaths during current week vs previous week, compared by data source", eval = FALSE}
# wk_gr_newdeaths_nrs_hps %>% 
#   filter(!is.na(ratio) & date >= dmy("26/04/2020")) %>%
# mutate(Ratio = formatC(round(ratio_m,2), format='f', digits=2),
#          lci = formatC(round(lci,2), format='f', digits=2),
#          uci = formatC(round(uci,2), format='f', digits=2)) %>%
#   mutate("95% CI" = paste0(lci, "-", uci)) %>%
#   select(date, source, Ratio, `95% CI`) %>%
#   mutate("Weekly Ratio" = paste(Ratio," (", `95% CI`, ")", sep = "")) %>%
#   select(date, source, `Weekly Ratio`) %>%
#   pivot_wider(names_from = source, values_from = `Weekly Ratio`) %>%
# write_csv("nrs_hps_weeklyratios_latest.csv")

fig1<- ggplot(wk_gr_newdeaths_nrs_hps %>% filter(!is.na(ratio) & date >= dmy("23/03/2020"))) +
  aes(x = date, y = ratio_m,
    ymin = lci, ymax = uci, 
    colour = source, fill = source) +
  geom_errorbar(width = 0, alpha = 0.4, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.3) +
  geom_line(position=position_dodge(width=0.3)) +
  geom_point(size = 1, position=position_dodge(width=0.3)) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "End Date of Current Week",
        y = "Weekly ratio",
        title = "Weekly ratio of new deaths",
        colour = "Source",
        fill = "Source") +
  scale_x_date(date_breaks = "2 week", labels = date_format("%b %d")) +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw(base_size = 12)

fig1_inset <- ggplot(wk_gr_newdeaths_nrs_hps %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newdeaths_nrs_hps$date)-20)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci,
    colour = source, fill = source) +
  geom_errorbar(width = 0, alpha = 0.4, position=position_dodge(width=0.2)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(position=position_dodge(width=0.2)) +
  geom_point(size = 1, position=position_dodge(width=0.2)) +
  scale_x_date(date_breaks = "6 days", labels = date_format("%b %d")) +
  scale_y_continuous(trans = "log10") +
  scale_colour_brewer(palette = "Dark2") +
  labs( x = "", y = "") +
  theme_bw(base_size = 10) +
  theme(legend.position = "none") 

ggdraw() +
  draw_plot(fig1) +
  draw_plot(fig1_inset, x = 0.40, y = .50, width = .42, height = .36) 
```


```{r ratiosnrshpsdaily, fig.width=8, fig.cap="Ratio of new deaths during current week vs previous week, compared by data source. Entries in grey are adjusted for public holiday effects, see Caveats. Figure insets highlight ratios and trends for the last 21 days."}
# wk_gr_newdeaths_nrs_hps %>% 
#   filter(!is.na(ratio) & date >= dmy("26/04/2020")) %>%
# mutate(Ratio = formatC(round(ratio_m,2), format='f', digits=2),
#          lci = formatC(round(lci,2), format='f', digits=2),
#          uci = formatC(round(uci,2), format='f', digits=2)) %>%
#   mutate("95% CI" = paste0(lci, "-", uci)) %>%
#   select(date, source, Ratio, `95% CI`) %>%
#   mutate("Weekly Ratio" = paste(Ratio," (", `95% CI`, ")", sep = "")) %>%
#   select(date, source, `Weekly Ratio`) %>%
#   pivot_wider(names_from = source, values_from = `Weekly Ratio`) %>%
# write_csv("nrs_hps_weeklyratios_latest.csv")

hps_adj <- filter(wk_gr_newdeaths_nrs_hps_adj, type == "adjusted" & source == "HPS")
nrs_adj <- filter(wk_gr_newdeaths_nrs_hps_adj, type == "adjusted" & source == "NRS")

fig1<- ggplot(wk_gr_newdeaths_nrs_hps %>% filter(!is.na(ratio) & date >= dmy("23/03/2020"))) +
  aes(x = date, y = ratio_m, ymin = lci, ymax = uci,  colour = source, fill = source) +
  geom_errorbar(width = 0, alpha = 0.4, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.3) +
  geom_line(position=position_dodge(width=0.3)) +
  geom_point(size = 1, position=position_dodge(width=0.3)) +
  geom_point(data = hps_adj, aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  geom_line(data = hps_adj, aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  geom_point(data = nrs_adj, aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  geom_line(data = nrs_adj, aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "End Date of Current Week",
        y = "Weekly ratio",
        title = "Weekly ratio of new deaths",
        colour = "Source",
        fill = "Source") +
  scale_x_date(date_breaks = "2 week", labels = date_format("%b %d")) +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw(base_size = 12)

fig1_inset <- ggplot(wk_gr_newdeaths_nrs_hps %>% filter(!is.na(ratio) & 
                    !is.infinite(ratio) & date >= max(wk_gr_newdeaths_nrs_hps$date)-20)) +
  aes(x = date, y = ratio,
    ymin = lci, ymax = uci,
    colour = source, fill = source) +
  geom_point(data = hps_adj %>% filter(date >= max(wk_gr_newdeaths_nrs_hps$date)-20), aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  geom_line(data = hps_adj %>% filter(date >= max(wk_gr_newdeaths_nrs_hps$date)-20), aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  geom_point(data = nrs_adj %>% filter(date >= max(wk_gr_newdeaths_nrs_hps$date)-20), aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  geom_line(data = nrs_adj %>% filter(date >= max(wk_gr_newdeaths_nrs_hps$date)-20), aes(x = date, y = ratio_m), colour = "grey51", show.legend = FALSE) +
  geom_errorbar(width = 0, alpha = 0.4, position=position_dodge(width=0.2)) +
  geom_hline(yintercept = 1, colour = "red", linetype = "dashed", size = 0.2) +
  geom_line(position=position_dodge(width=0.2)) +
  geom_point(size = 1, position=position_dodge(width=0.2)) +
  scale_x_date(date_breaks = "10 days", labels = date_format("%b %d")) +
  scale_y_continuous(trans = "log10") +
  scale_colour_brewer(palette = "Dark2") +
  labs( x = "", y = "") +
  theme_bw(base_size = 10) +
  theme(legend.position = "none") 

ggdraw() +
  draw_plot(fig1) +
  draw_plot(fig1_inset, x = 0.35, y = .47, width = .50, height = .42) 
```


```{r deathdayweek}
first_day <- as.data.frame(cbind(first_day = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"),
levels = list(list("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"),
list("Tue", "Wed", "Thu", "Fri", "Sat", "Sun", "Mon"),
list("Wed", "Thu", "Fri", "Sat", "Sun","Mon", "Tue"),
list("Thu", "Fri", "Sat", "Sun", "Mon", "Tue", "Wed"),
list("Fri", "Sat", "Sun", "Mon", "Tue", "Wed", "Thu"),
list("Sat", "Sun", "Mon", "Tue", "Wed", "Thu", "Fri"),
list("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))))


scot_deaths_week <- scot_deaths %>%
  filter(date > ymd("2020-03-12")) %>%
mutate(dayofweek = weekdays(date, abbreviate = TRUE)) %>%
mutate(day_no = case_when(dayofweek == "Mon" ~ 0, 
                          dayofweek == "Tue" ~ 6,
                          dayofweek == "Wed" ~ 5,
                          dayofweek == "Thu" ~ 4,
                          dayofweek == "Fri" ~ 3,
                          dayofweek == "Sat" ~ 2,
                          dayofweek == "Sun" ~ 1
                          )) %>%
#mutate(week = cut(date + 1, "week")) %>%
mutate(week = cut(date + day_no[nrow(.)-6], "week")) %>%
mutate(week = ymd(week)-day_no[nrow(.)-6])%>%
mutate(dayofweek = factor(dayofweek, 
                          levels = unlist(subset(first_day, first_day == .$dayofweek[nrow(.)-6])$levels)))


scot_data_week <- scot_data %>%
mutate(dayofweek = weekdays(date, abbreviate = TRUE)) %>%
mutate(day_no = case_when(dayofweek == "Mon" ~ 0, 
                          dayofweek == "Tue" ~ 6,
                          dayofweek == "Wed" ~ 5,
                          dayofweek == "Thu" ~ 4,
                          dayofweek == "Fri" ~ 3,
                          dayofweek == "Sat" ~ 2,
                          dayofweek == "Sun" ~ 1
                          )) %>%
#mutate(week = cut(date + 1, "week")) %>%
mutate(week = cut(date + day_no[nrow(.)-6], "week")) %>%
mutate(week = ymd(week)-day_no[nrow(.)-6])%>%
mutate(dayofweek = factor(dayofweek, 
                          levels = unlist(subset(first_day, first_day == .$dayofweek[nrow(.)-6])$levels)))


last_two_weeks_deaths <- unique(arrange(scot_deaths_week, desc(date))$week)[1:2] 
last_two_weeks <- unique(arrange(scot_data_week, desc(date))$week)[1:2] 



# fig1 <- ggplot(scot_deaths_week) + 
#   geom_point(aes(x = dayofweek, y = new_deaths, colour = factor(week))) +
#   geom_line(aes(x = dayofweek, y = new_deaths, colour = factor(week), group = week)) + 
#   scale_y_continuous(trans = "log10",
#                          labels = scales::comma_format(accuracy = 1),
#                          #breaks = breaks,
#                          expand = expansion(mult = 0.1)) + theme_bw(base_size = 12) +
#   guides(colour = guide_legend(reverse = TRUE)) +
#   labs(x = "", y = "New deaths", colour = "Week beginning")
# 
# fig2 <- ggplot(scot_data_week) + 
#   geom_point(aes(x = dayofweek, y = new_cases, colour = factor(week))) +
#   geom_line(aes(x = dayofweek, y = new_cases, colour = factor(week), group = week)) + 
#   scale_y_continuous(trans = "log10",
#                          labels = scales::comma_format(accuracy = 1),
#                          #breaks = breaks,
#                          expand = expansion(mult = 0.1)) + theme_bw(base_size = 12) +
#   guides(colour = guide_legend(reverse = TRUE)) +
#   labs(x = "", y = "New cases", colour = "Week beginning")
# 
# gridExtra::grid.arrange(fig1, fig2, nrow = 2) 
```


```{r, fig.width=7, fig.cap="Number of cases by weekday, shown for different weeks", eval = FALSE}
ggplot(scot_data_week) + 
  geom_point(aes(x = dayofweek, y = new_cases, colour = factor(week))) +
  geom_line(aes(x = dayofweek, y = new_cases, colour = factor(week), group = week)) + 
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) + theme_bw(base_size = 12) +
  guides(colour = guide_legend(reverse = TRUE)) +
  labs(x = "", y = "New cases", colour = "Week beginning")
```

```{r dayoftheweeklast2weeks, fig.width=6, fig.height=3.5, fig.cap="Number of cases and deaths by week day, shown for the last two weeks. Data source: HPS"}
bind_rows(scot_data_week %>% filter(week %in% last_two_weeks) %>% mutate(Type = "Cases") %>% rename("New" = new_cases),
          scot_deaths_week %>% filter(week %in% last_two_weeks) %>% mutate(Type = "Deaths") %>% rename("New" = new_deaths)) %>% 
  ggplot() + 
  geom_point(aes(x = dayofweek, y = New, colour = factor(week))) +
  geom_line(aes(x = dayofweek, y = New, colour = factor(week), group = week)) + 
  scale_y_continuous(#trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) + theme_bw(base_size = 12) +
  scale_colour_brewer(palette = "Dark2") +
  guides(colour = guide_legend(reverse = TRUE)) +
  labs(x = "", y = "Number of new cases or deaths", colour = "Week beginning") + facet_grid(Type~., scales = "free_y")
  
```

```{r, eval = FALSE}
ggplot(scot_deaths_week) + 
  geom_point(aes(x = dayofweek, y = new_deaths, colour = factor(week))) +
  geom_line(aes(x = dayofweek, y = new_deaths, colour = factor(week), group = week)) + 
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) + theme_bw(base_size = 12) +
  guides(colour = guide_legend(reverse = TRUE)) +
  labs(x = "", y = "New deaths", colour = "Week beginning") 
```


```{r, fig.height=8, eval = FALSE}
ggplot(scot_deaths_week) + 
  geom_point(aes(x = dayofweek, y = new_deaths, colour = factor(week))) +
  geom_line(aes(x = dayofweek, y = new_deaths, colour = factor(week), group = week)) + 
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) + theme_bw(base_size = 8) +
  guides(colour = guide_legend(reverse = TRUE)) +
  labs(x = "", y = "New deaths", colour = "Week beginning") +
  facet_grid(week~., scales = "free_y")
```


```{r deathsnodaily, fig.width=6,fig.height=3.5,fig.align="left",fig.cap="Cumulative number of deaths, compared by data source", eval = FALSE}
ggplot(bind_rows(scot_deaths %>% mutate(Source = "HPS"), nrs_deaths_covid_raw_daily %>% rename(deaths = `Cumulative Count`)) ) +
  aes(x = date, y = deaths,
    colour = Source, fill = Source) +
  geom_line() +
  geom_point(size = 1) +
  scale_y_continuous(trans = "log10",
                         labels = scales::comma_format(accuracy = 1),
                         #breaks = breaks,
                         expand = expansion(mult = 0.1)) +
  labs( x = "Date",
        y = "Cumulative Deaths",
        title = "Cumulative number of deaths by data source", 
        colour = "Source",
        fill = "Source") +
  scale_x_date(date_breaks = "2 week", labels = date_format("%b %d")) +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw(base_size = 12)
```

\hfill \break
\hfill \break

This report was produced by Helen Brown^1^, Giles Calder-Gerver^2^, Samuel Haynes^3^, Stella Mazeri^1^, Camille A Simonet^4^ and Mark Woolhouse^2,3,\*^.
\hfill \break

Affiliations:^1^The Roslin Institute and The Royal (Dick) School of Veterinary Studies, University of Edinburgh, Edinburgh, UK. ^2^Usher Institute, University of Edinburgh, Edinburgh, UK. ^3^School of Biological Sciences, University of Edinburgh, Edinburgh, UK. ^4^Institute of Evolutionary Biology, School of Biological Sciences, University of Edinburgh, Edinburgh, UK \newline


^\*^Email: Mark.Woolhouse@ed.ac.uk \newline
